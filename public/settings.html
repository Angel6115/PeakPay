<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PeekPay — Ajustes de cuenta</title>

  <!-- Orden: env -> supabase CDN -> _header -->
  <script src="./env.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./_header.js" defer></script>

  <link rel="icon" href="./favicon.ico">
  <link rel="preload" as="style" href="./styles.min.css" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="./styles.min.css"></noscript>

  <style>
    :root{ --ring:#e2e8f0; --muted:#475569; --ok:#059669; --err:#b91c1c; --indigo:#4f46e5; --blue:#2563eb;}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Arial,sans-serif;background:#fff;color:#0b1020}
    .wrap{max-width:980px;margin:0 auto;padding:18px 12px 64px}
    .top{display:flex;align-items:center;gap:8px;margin-bottom:10px}
    .back{border:1px solid #c7d2fe;background:#eef2ff;color:#1e1b4b;border-radius:999px;padding:8px 12px;text-decoration:none}
    .card{border:1px solid var(--ring);border-radius:16px;box-shadow:0 8px 22px rgba(79,70,229,.06);background:#f8fafc}
    .inner{padding:14px}
    label{font-size:12px;color:var(--muted)}
    input{width:100%;border:1px solid var(--ring);border-radius:10px;padding:10px;font-size:14px;background:#fff}
    .row{display:grid;grid-template-columns:1fr;gap:10px}
    .btn{border:0;background:linear-gradient(90deg,var(--indigo),var(--blue));color:#fff;border-radius:10px;padding:10px 14px;cursor:pointer;box-shadow:0 6px 16px rgba(79,70,229,.25)}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .btn.out{background:#fff;color:#1f2937;border:1px solid var(--ring);box-shadow:none}
    .msg{font-size:13px;margin-top:8px}
    .ok{color:var(--ok)} .err{color:var(--err)}
    .avatar{width:96px;height:96px;border-radius:14px;border:1px solid #e5e7eb;object-fit:cover;background:#fff}
    .hint{font-size:12px;color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    @media(min-width:860px){ .grid{grid-template-columns:1.2fr .8fr} }
    .danger{border:1px dashed #fecaca;background:#fff;border-radius:10px;padding:10px;color:#991b1b;font-size:12px}
    .bar-warn{margin:10px 0 0;border:1px solid #fecaca;background:#fee2e2;color:#991b1b;border-radius:12px;padding:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <a id="btnBack" class="back" href="./profile.html">Volver</a>
      <div style="margin-left:auto;font-size:12px;color:#64748b" id="sessionState">Cargando…</div>
    </div>

    <div class="grid">
      <section class="card">
        <div class="inner">
          <h2 style="margin:0 0 10px">Ajustes de cuenta</h2>

          <div id="warn" class="bar-warn" style="display:none">
            No hay sesión iniciada en esta pestaña.
            <a href="./auth-signup.html?return=./settings.html" style="color:#1d4ed8">Entrar</a> para continuar.
          </div>

          <div style="display:flex;gap:12px;align-items:center;margin:10px 0">
            <img id="imgAvatar" class="avatar" src="./peak1.png" alt="avatar"/>
            <div>
              <input id="file" type="file" accept="image/*" style="display:none"/>
              <button id="btnUpload" class="btn out">Subir imagen…</button>
              <div class="hint">Si subes, copiamos la URL pública automáticamente.</div>
            </div>
          </div>

          <div class="row">
            <div>
              <label>Nombre para mostrar</label>
              <input id="name" type="text" placeholder="Tu nombre">
            </div>
            <div>
              <label>@handle</label>
              <input id="handle" type="text" placeholder="Sólo letras, números y _">
            </div>
            <div>
              <label>URL del avatar</label>
              <input id="avatar" type="text" placeholder="https://…/mi-foto.jpg">
            </div>
          </div>

          <div style="margin-top:10px;display:flex;gap:8px;align-items:center">
            <button id="save" class="btn">Guardar perfil</button>
            <span id="msg" class="msg"></span>
          </div>
        </div>
      </section>

      <section class="card">
        <div class="inner">
          <h3 style="margin:0 0 8px">Seguridad</h3>
          <div class="row">
            <div>
              <label>Email</label>
              <input id="email" type="text" disabled placeholder="—">
            </div>
          </div>
          <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
            <button id="sendReset" class="btn out">Enviar enlace para cambiar contraseña</button>
            <button id="logout" class="btn out">Cerrar sesión</button>
          </div>
          <div class="danger" style="margin-top:10px">
            Por seguridad, es posible que se cierren sesiones en otros dispositivos al cambiar datos sensibles.
          </div>
        </div>
      </section>
    </div>
  </div>

  <script>
    // ---- Cliente unificado: usa window.__SB si existe; si no, créalo con MISMO storageKey ----
    function getSB(){
      if (window.__SB) return window.__SB;
      const E = window.PP_ENV || {};
      if (!E.sb_url || !E.sb_anon || !window.supabase?.createClient) return null;
      const auth = { persistSession:true, autoRefreshToken:true, detectSessionInUrl:true, storageKey:'pp-auth' };
      window.__SB = window.supabase.createClient(E.sb_url, E.sb_anon, { auth });
      window.sb = window.__SB;
      return window.__SB;
    }

    const $ = s => document.querySelector(s);
    const sessionState = $('#sessionState');
    const warn = $('#warn');
    const img = $('#imgAvatar');
    const f = $('#file');
    const btnUpload = $('#btnUpload');
    const name = $('#name');
    const handle = $('#handle');
    const avatar = $('#avatar');
    const email = $('#email');
    const save = $('#save');
    const msg = $('#msg');
    const sendReset = $('#sendReset');
    const logout = $('#logout');

    // Volver con ?return= si viene de otra pantalla
    (function mountBack(){
      const getReturn = window.__pp_getReturn || ((d)=>d||'./profile.html');
      $('#btnBack').href = getReturn('./profile.html');
      $('#btnBack').onclick = (e)=>{ e.preventDefault(); location.href = getReturn('./profile.html'); };
    })();

    function setMsg(t, ok){ msg.textContent = t||''; msg.className = 'msg ' + (ok?'ok':'err'); }

    async function boot(){
      const sb = getSB();
      if (!sb){
        sessionState.textContent = 'Sin Supabase';
        warn.style.display = '';
        disableUI(true);
        return;
      }

      try{
        const { data:{ session } } = await sb.auth.getSession();
        if (!session){
          sessionState.textContent = 'Sin sesión';
          warn.style.display = '';
          disableUI(true);
          return;
        }
        warn.style.display = 'none';
        sessionState.textContent = session.user.email || 'Sesión activa';
        email.value = session.user.email || '';
        disableUI(false);

        // Precarga metadata
        const m = session.user.user_metadata || {};
        name.value   = m.name || '';
        handle.value = m.handle || '';
        const pic = m.avatar_url || m.picture || '';
        if (pic) img.src = avatar.value = pic;

        // Botón subir -> input file
        btnUpload.onclick = ()=> f.click();
        f.onchange = async ()=>{
          if (!f.files || !f.files[0]) return;
          try{
            setMsg('Subiendo imagen…');
            // Subir a Supabase Storage (bucket "avatars")
            const file = f.files[0];
            const ext = (file.name.split('.').pop()||'jpg').toLowerCase();
            const key = `u/${session.user.id}/${Date.now()}.${ext}`;
            const { error } = await sb.storage.from('avatars').upload(key, file, { upsert:false });
            if (error) throw error;

            const { data } = sb.storage.from('avatars').getPublicUrl(key);
            if (!data?.publicUrl) throw new Error('No se obtuvo URL pública');
            avatar.value = data.publicUrl;
            img.src = data.publicUrl;
            setMsg('Imagen subida ✓', true);
          }catch(e){ setMsg(e.message||'No se pudo subir la imagen'); }
          finally{ f.value = ''; }
        };

        // Guardar perfil
        save.onclick = async ()=>{
          try{
            setMsg('Guardando…');
            const updates = {
              data: {
                name: (name.value||'').trim(),
                handle: (handle.value||'').trim(),
                avatar_url: (avatar.value||'').trim()
              }
            };
            const { error:err1 } = await sb.auth.updateUser(updates);
            if (err1) throw err1;
            setMsg('Perfil actualizado ✓', true);
          }catch(e){ setMsg(e.message||'No se pudo guardar.'); }
        };

        // Reset password (magic link)
        sendReset.onclick = async ()=>{
          try{
            setMsg('Enviando enlace…');
            const back = location.origin + '/auth-callback.html';
            const { error } = await sb.auth.resetPasswordForEmail(session.user.email, { redirectTo: back });
            if (error) throw error;
            setMsg('Te enviamos un enlace para cambiar tu contraseña.', true);
          }catch(e){ setMsg(e.message||'No pudimos enviar el enlace.'); }
        };

        logout.onclick = async ()=>{
          try{ await sb.auth.signOut(); }catch{}
          location.href = './auth-signup.html?return=./profile.html';
        };

      }catch(e){
        console.warn(e);
        sessionState.textContent = 'Error de sesión';
        warn.style.display = '';
        disableUI(true);
      }
    }

    function disableUI(dis){
      [btnUpload, save, sendReset, logout, name, handle, avatar].forEach(el=>{
        el.disabled = !!dis;
      });
    }

    // Go!
    document.addEventListener('DOMContentLoaded', boot);
  </script>
</body>
</html>
