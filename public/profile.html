<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>PeekPay — Perfil</title>

    <script src="./env.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./_header.js" defer></script>

  <link rel="icon" href="./favicon.ico">
  <link rel="preload" as="style" href="./styles.min.css" onload="this.onload=null;this.rel='stylesheet'">
  <noscript><link rel="stylesheet" href="./styles.min.css"></noscript>

  <style>
    :root{ --bg:#fff; --text:#0b1020; --muted:#5b667a; --ring:#e5e7eb; --card:#f8fafc; --indigo:#4f46e5; --blue:#2563eb; --shadow:0 8px 20px rgba(79,70,229,.10); --radius:16px; }
    html,body{margin:0;background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Arial,sans-serif;}
    .wrap{max-width:1100px;margin:0 auto;padding:18px 14px 80px}
    .topbar{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:8px;font-weight:800}
    .brand img{width:22px;height:22px;border-radius:6px;box-shadow:0 6px 10px rgba(79,70,229,.18)}
    .crumbs{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
    .crumbs a{font-size:13px;color:#374151;text-decoration:none;padding:8px 12px;border:1px solid var(--ring);background:#fff;border-radius:999px}
    .crumbs a:hover{border-color:#c7d2fe;background:#eef2ff}
    @media (max-width:560px){ .crumbs{width:100%;margin-left:0} .crumbs a{flex:1;text-align:center} }

    .grid{display:grid;grid-template-columns:340px 1fr;gap:18px;margin-top:12px}
    @media (max-width:960px){ .grid{grid-template-columns:1fr} }
    .card{background:var(--card);border:1px solid var(--ring);border-radius:var(--radius);box-shadow:var(--shadow)}
    .panel{background:#fff;border:1px solid var(--ring);border-radius:var(--radius);box-shadow:var(--shadow)}
    .card .inner,.panel .inner,.section{padding:14px}

    .hero{display:flex;align-items:center;gap:14px}
    .avatar{width:70px;height:70px;border-radius:12px;border:1px solid #e6e6e6;object-fit:cover;background:#fff}
    .tags{display:flex;gap:6px;flex-wrap:wrap;margin-top:4px}
    .tag{font-size:12px;color:#374151;border:1px solid var(--ring);background:#fff;border-radius:999px;padding:3px 8px}
    .kpis{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .kpi{font-size:12px;border:1px solid var(--ring);background:#fff;border-radius:10px;padding:6px 8px}

    .actions{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px}
    .btn{border:1px solid var(--ring);background:#fff;color:#111827;border-radius:10px;padding:10px 12px;cursor:pointer}
    .btn.primary{border:0;background:linear-gradient(90deg,var(--indigo),var(--blue));color:#fff;box-shadow:0 8px 18px rgba(79,70,229,.25)}
    .menu{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px}
    @media (max-width:420px){ .menu{grid-template-columns:1fr} }
    .hint{font-size:12px;color:var(--muted);margin-top:10px}

    .section h3{margin:0 0 8px 0;font-size:15px}
    .row{display:flex;align-items:center;justify-content:space-between;gap:12px}
    .pill{font-size:12px;border:1px solid var(--ring);background:#fff;border-radius:999px;padding:6px 10px;cursor:pointer}
    .list{display:grid;gap:8px}
    .item{border:1px solid var(--ring);background:#fff;border-radius:12px;padding:10px;display:flex;justify-content:space-between;align-items:center}
    .item .left{display:flex;align-items:center;gap:10px}
    .mini{width:28px;height:28px;border-radius:999px;border:1px solid var(--ring);object-fit:cover;background:#fff}
    .switch{display:inline-flex;align-items:center;gap:6px}
    .notifBadge{display:none;margin-left:8px;min-width:18px;height:18px;padding:0 6px;border-radius:999px;font-size:11px;background:#ef4444;color:#fff;display:inline-flex;align-items:center;justify-content:center}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="topbar">
      <div class="brand"><img src="./peak1.png" alt="PeekPay"/><span>PeekPay</span></div>
      <nav class="crumbs">
        <a href="./index.html?return=./profile.html">Inicio</a>
        <a href="./categories.html?return=./profile.html">Categorías</a>
        <a href="./creators.html?return=./profile.html">Explorar Creadores</a>
        <a href="./notifications.html?return=./profile.html">Notificaciones <span class="notifBadge">0</span></a>
        <a href="./wallet.html?return=./profile.html">Wallet</a>
        <a href="./settings.html?return=./profile.html">Ajustes</a>
      </nav>
    </div>

    <div class="grid">
      <div class="card">
        <div class="inner">
          <div class="hero">
            <img class="avatar" src="./peak1.png" alt="avatar" id="u-avatar">
            <div>
              <div style="font-weight:700" id="u-name">Demo User</div>
              <div class="tags">
                <span class="tag" id="u-handle">@test-user</span>
                <span class="tag" id="u-country">Global</span>
              </div>
              <div class="kpis">
                <div class="kpi" id="kpiCredits">Peak Credits: 0  ≈ $0.00</div>
                <div class="kpi" id="kpiPoints">Puntos: 0</div>
              </div>
            </div>
          </div>

          <div class="actions">
            <button class="btn primary" onclick="goto('./wallet.html?return=./profile.html')">Wallet</button>
            <button id="btnMsg" class="btn" onclick="alert('Mensajería llegará pronto ✨')">Mensajes</button>
          </div>

          <div class="menu">
            <button class="btn" onclick="goto('./index.html?return=./profile.html')">Home</button>
            <button class="btn" onclick="goto('./creators.html?return=./profile.html')">Explorar Creadores</button>
            <button class="btn" onclick="goto('./categories.html?return=./profile.html')">Categorías</button>
            <button class="btn" onclick="goto('./notifications.html?return=./profile.html')">Notificaciones</button>
          </div>

          <div class="hint">Consejo: abre tus peeks desde <b>Wallet</b> o explora nuevos creadores. Tu saldo se actualiza automáticamente.</div>
          <div class="muted" id="sbHint" style="margin-top:6px">Sin Supabase (modo demo local).</div>
        </div>
      </div>

      <div class="panel">
        <div class="section" id="favSection">
          <div class="row"><h3>Favoritos recientes</h3><button class="pill" onclick="goto('./creators.html?return=./profile.html')">Explorar</button></div>
          <div class="muted" id="favEmpty">Inicia sesión para ver favoritos.</div>
          <div class="list" id="favList" style="display:none"></div>
        </div>

        <div class="section">
          <div class="row"><h3>Notificaciones</h3><button class="pill" onclick="goto('./notifications.html?return=./profile.html')">Ver todas</button></div>
          <div class="muted">Sin novedades por ahora.</div>
        </div>

        <div class="section">
          <h3>Privacidad</h3>
          <div class="list">
            <label class="switch"><input type="checkbox" id="p_public"> <span>Perfil visible públicamente</span></label>
            <label class="switch"><input type="checkbox" id="p_handle" checked> <span>Mostrar @handle</span></label>
            <label class="switch"><input type="checkbox" id="p_msgs" checked> <span>Permitir mensajes</span></label>
          </div>
          <div class="muted" style="margin-top:6px">Tus ajustes se guardan en tu cuenta. Si no has iniciado sesión, se guardan solo en este navegador.</div>
        </div>

        <div class="section">
          <h3>Actividad reciente</h3>
          <div class="list" id="activityList">
            <div class="item"><span>No hay actividad aún.</span><span class="muted">—</span></div>
          </div>
        </div>

        <div class="section">
          <div class="row"><h3>Pedido especial</h3><button class="pill" id="openRequest">Abrir</button></div>
          <div class="muted">Envía una solicitud breve a un creador favorito. No se permiten correos, teléfonos o enlaces.</div>
        </div>

        <div class="section">
          <div class="row"><h3>Datos & seguridad</h3>
            <div style="display:flex;gap:8px;flex-wrap:wrap">
              <button class="pill" onclick="exportData()">Exportar</button>
              <button class="pill" onclick="goto('./settings.html?return=./profile.html')">Ajustes</button>
              <button class="pill" id="btnResetPwd">Cambiar contraseña</button>
              <button class="pill" id="btnSignout">Cerrar sesión</button>
            </div>
          </div>
          <div class="muted" id="sbNote">Sin Supabase configurado.</div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const sb = window.__SB || window.supabaseClient || null;
    const API_BASE = (localStorage.getItem('pp_api_base') || '').replace(/\/+$/,'');
    const PP_UID   = localStorage.getItem('pp_uid') || 'test-user-123';
    localStorage.setItem('pp_uid', PP_UID);

    const fmtUSD = v => Number(v||0).toLocaleString('en-US',{style:'currency',currency:'USD'});
    const CREDIT_TO_USD = 0.25;

    function goto(href){ location.href = href; }

    // === Tarjeta de usuario (nombre/@/avatar) ===
    async function refreshUserCard(){
      const el = $('#sbHint');
      if (!sb){ el.textContent='Sin Supabase (modo demo local).'; return; }
      const { data:{ session } } = await sb.auth.getSession();
      if (!session){ el.textContent='Sin Supabase (modo demo local).'; return; }
      el.textContent = 'Perfil leído desde Supabase.';
      const u = session.user;
      const name = u.user_metadata?.name || u.email || 'Mi cuenta';
      const handle = u.user_metadata?.handle || (u.email||'user').split('@')[0];
      const country = u.user_metadata?.country;
      const pic = u.user_metadata?.avatar_url || u.user_metadata?.picture;

      $('#u-name').textContent = name;
      $('#u-handle').textContent = '@' + handle;
      if (country) $('#u-country').textContent = country;
      if (pic){ const img = new Image(); img.onload=()=>{$('#u-avatar').src=pic}; img.src=pic; }
    }

    // Notif badge
    async function refreshUnreadBadge(){
      if (!sb) return;
      try{
        const { data:{ session } } = await sb.auth.getSession();
        if (!session) return;
        const { data } = await sb.from('v_unread_counts').select('unread').eq('user_id', session.user.id).maybeSingle();
        const n = data?.unread || 0;
        const b = document.querySelector('.notifBadge');
        if (b){ b.textContent = n; b.style.display = n ? 'inline-flex' : 'none'; }
      }catch{}
    }

    // Favoritos (si existe la vista)
    (async function loadFavs(){
      const list = $('#favList');
      const empty = $('#favEmpty');
      if (!sb) return;
      try{
        const { data: { session } } = await sb.auth.getSession();
        if (!session) return;
        const { data } = await sb.from('v_user_favorites')
          .select('creator_id, creator_handle, creator_name, creator_avatar_url, last_seen')
          .order('last_seen',{ascending:false}).limit(6);
        if (data && data.length){
          empty.style.display='none'; list.style.display='grid'; list.innerHTML='';
          data.forEach(r=>{
            const it = document.createElement('div');
            it.className = 'item';
            it.innerHTML = `
              <div class="left">
                <img class="mini" src="${r.creator_avatar_url || './peak1.png'}" alt="">
                <div>
                  <div style="font-weight:600">${r.creator_name || r.creator_handle}</div>
                  <div class="muted">@${r.creator_handle}</div>
                </div>
              </div>
              <button class="pill" onclick="goto('./peek.html?creator=${encodeURIComponent(r.creator_handle)}&return=./profile.html')">Ver</button>
            `;
            list.appendChild(it);
          });
        }
      }catch{}
    })();

    // API helper (opcional)
    function apiGet(path){
      if (!API_BASE) return Promise.reject(new Error('API base no configurada'));
      return fetch(API_BASE + path, { headers:{ 'X-PP-UID': PP_UID }})
        .then(r=>{ if(!r.ok) throw new Error('GET '+path+' '+r.status); return r.json(); });
    }

    // KPIs
    async function syncWalletKPIs(){
      const elCr = $('#kpiCredits'), elPt = $('#kpiPoints');
      if (API_BASE){
        try{
          const j = await apiGet('/api/credits/balance');
          const cr = j?.credits ?? 0;
          const pt = j?.points ?? 0;
          elCr.textContent = `Peak Credits: ${cr}  ≈ ${fmtUSD(cr*CREDIT_TO_USD)}`;
          elPt.textContent = `Puntos: ${pt}`;
          return;
        }catch{}
      }
      if (!sb){ elCr.textContent=`Peak Credits: 0  ≈ ${fmtUSD(0)}`; elPt.textContent='Puntos: 0'; return; }
      try{
        const { data } = await sb.from('v_user_wallet').select('credits,points,usd_equiv').limit(1);
        if (Array.isArray(data) && data.length){
          elCr.textContent = `Peak Credits: ${data[0].credits||0}  ≈ ${fmtUSD(data[0].usd_equiv||0)}`;
          elPt.textContent = `Puntos: ${data[0].points||0}`; return;
        }
      }catch{}
      try{
        const { data } = await sb.from('v_wallet_activity_recent').select('running_credits').order('ts',{ascending:false}).limit(1);
        const cr = (data && data[0]?.running_credits) || 0;
        elCr.textContent = `Peak Credits: ${cr}  ≈ ${fmtUSD(cr*CREDIT_TO_USD)}`;
        const { data: pts } = await sb.from('wallet_history').select('points').gt('points',0).limit(1000);
        const sumPts = Array.isArray(pts) ? pts.reduce((a,b)=>a+(b.points||0),0) : 0;
        elPt.textContent = `Puntos: ${sumPts}`;
      }catch{
        elCr.textContent = `Peak Credits: 0  ≈ ${fmtUSD(0)}`;
        elPt.textContent = `Puntos: 0`;
      }
    }

    // Actividad
    const activityList = $('#activityList');
    function renderEmptyActivity(){
      activityList.innerHTML = `<div class="item"><span>No hay actividad aún.</span><span class="muted">—</span></div>`;
    }
    function renderActivityItems(items){
      if (!items?.length){ renderEmptyActivity(); return; }
      activityList.innerHTML = '';
      const fmtWhen = ts => { try{ return new Date(ts).toLocaleString(); }catch{ return String(ts||''); } };
      for (const it of items){
        const type = it.type || it.kind || 'mov';
        const when = fmtWhen(it.ts);
        const meta = it.meta || {};
        let label = '';
        if (type==='topup') label = `Recarga ${fmtUSD(it.usd)} (+${it.credits} cr)`;
        else if (type==='unlock') label = `Consumo ${it.credits} cr${meta.set?` · ${meta.set}`:''}`;
        else if (type==='weekly_streak_bonus') label = `Bono semanal (+${it.points||0} pts${it.credits?` · +${it.credits} cr`:''})`;
        else if (type==='streak_bonus') label = `Bono diario (+${it.points||0} pts)`;
        else label = type;
        const row = document.createElement('div');
        row.className = 'item';
        row.innerHTML = `<span>${label}</span><span class="muted">${when}</span>`;
        activityList.appendChild(row);
      }
    }
    async function loadActivity(){
      if (API_BASE){
        try{
          const j = await apiGet('/api/credits/history?limit=20');
          renderActivityItems(j?.items || []); return;
        }catch{}
      }
      if (!sb){ renderEmptyActivity(); return; }
      try{
        const { data } = await sb.from('v_wallet_activity_recent')
          .select('ts,type,credits,usd,points,kind,meta')
          .order('ts',{ascending:false}).limit(15);
        const mapped = (data||[]).map(r=>({ ts:r.ts, type:r.type||r.kind, credits:r.credits, usd:r.usd, points:r.points, meta:r.meta||{} }));
        renderActivityItems(mapped);
      }catch{ renderEmptyActivity(); }
    }

    // Acciones de seguridad rápidas
    (function secActions(){
      const sbNote = $('#sbNote');
      if (!sb){ sbNote.textContent='Sin Supabase configurado.'; return; }
      sbNote.textContent = 'Gestiona tu cuenta desde Ajustes.';
      $('#btnResetPwd').onclick = async ()=>{
        const { data:{ session } } = await sb.auth.getSession();
        if (!session) { alert('Inicia sesión primero.'); return; }
        const url = new URL('./auth-callback.html', location.origin);
        url.searchParams.set('type','recovery');
        url.searchParams.set('return','./profile.html');
        try{
          await sb.auth.resetPasswordForEmail(session.user.email, { redirectTo: url.toString() });
          alert('Te enviamos un enlace para cambiar la contraseña.');
        }catch(e){ alert(e.message || 'No se pudo enviar el enlace.'); }
      };
      $('#btnSignout').onclick = async ()=>{ try{ await sb.auth.signOut(); }catch{} location.replace('./auth-signup.html'); };
    })();

    // Bootstrap + listeners
    (async function bootstrap(){
      await Promise.all([refreshUserCard(), syncWalletKPIs(), loadActivity(), refreshUnreadBadge()]);
      window.addEventListener('focus', ()=> setTimeout(()=>{ refreshUserCard(); syncWalletKPIs(); loadActivity(); refreshUnreadBadge(); }, 350));
      setInterval(()=>{ syncWalletKPIs(); loadActivity(); }, 60_000);

      // ♥ Escucha cambios desde Ajustes (sin recargar)
      window.addEventListener('storage', (e)=>{
        if (e && e.key === 'pp_profile_updated'){ refreshUserCard(); }
      });
    })();
  </script>
</body>
</html>
