<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PeekPay — Conectando…</title>

  <!-- Supabase primero -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./_header.js"></script>

  <style>
    :root{ --text:#0b1020; --muted:#475569; --ring:#e2e8f0; --ok:#065f46; --okbg:#d1fae5; --err:#7f1d1d; --errbg:#fee2e2; }
    body{ font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Arial,sans-serif; margin:0; display:grid; place-items:center; min-height:100vh; color:var(--text) }
    .card{ border:1px solid var(--ring); border-radius:14px; padding:18px 16px; max-width:560px; width:92%; box-shadow:0 6px 14px rgba(79,70,229,.06) }
    h1{ font-size:18px; margin:0 0 8px }
    .muted{ font-size:13px; color:var(--muted) }
    .note{ margin-top:10px; padding:10px 12px; border-radius:10px; font-size:13px }
    .ok{ background:var(--okbg); color:var(--ok); border:1px solid #a7f3d0 }
    .err{ background:var(--errbg); color:var(--err); border:1px solid #fecaca }
    .small{ font-size:12px; color:var(--muted); margin-top:6px }
    input[type=password]{ width:100%; border:1px solid var(--ring); border-radius:10px; padding:10px; font-size:14px; margin-top:8px }
    .actions{ display:flex; gap:8px; margin-top:10px }
    .btn{ border:1px solid var(--ring); background:#fff; border-radius:10px; padding:10px 12px; cursor:pointer }
    .btn.primary{ border:0; background:linear-gradient(90deg,#4f46e5,#2563eb); color:#fff; box-shadow:0 8px 18px rgba(79,70,229,.25) }
  </style>
</head>
<body>
  <div class="card">
    <h1 id="title">Conectando con tu cuenta…</h1>
    <div id="msg" class="muted">Procesando el enlace.</div>

    <!-- Bloque normal (login / magic link) -->
    <div id="normal" style="display:none">
      <div id="note" class="note ok" style="display:none"></div>
      <div id="err" class="note err" style="display:none"></div>
      <div class="small">Si esta pantalla queda aquí, vuelve a <a href="./auth-signup.html">Entrar</a> y solicita otro enlace.</div>
    </div>

    <!-- Bloque recovery (fijar nueva contraseña) -->
    <div id="recovery" style="display:none">
      <div class="muted">Introduce tu nueva contraseña para finalizar el cambio.</div>
      <input id="pwd1" type="password" placeholder="Nueva contraseña (mín. 8)" minlength="8">
      <input id="pwd2" type="password" placeholder="Repite la contraseña" minlength="8">
      <div class="actions">
        <button id="setPwd" class="btn primary">Guardar contraseña</button>
        <button id="cancel" class="btn" type="button">Cancelar</button>
      </div>
      <div id="recNote" class="note ok" style="display:none"></div>
      <div id="recErr" class="note err" style="display:none"></div>
      <div class="small">Tras guardar, te redirigiremos a tu perfil.</div>
    </div>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const sb = window.__SB || window.supabaseClient;

    function getParam(name){
      const u = new URL(location.href);
      return u.searchParams.get(name) || new URLSearchParams(u.hash.replace(/^#/, '')).get(name);
    }
    const isRecovery = ()=> {
      // Supabase añade type=recovery en el hash del enlace
      const hash = new URL(location.href).hash;
      return /type=recovery/i.test(hash);
    };

    function returnTo(){
      // Si venías con ?return= lo respetamos, si no, a profile
      const u = new URL(location.href);
      const r = u.searchParams.get('return');
      return r || './profile.html';
    }

    async function upsertProfile(user){
      try{
        const payload = {
          id: user.id,
          email: user.email || user.user_metadata?.email || null,
          name:  user.user_metadata?.name || user.email?.split('@')[0] || 'Usuario',
          avatar_url: user.user_metadata?.avatar_url || user.user_metadata?.picture || null,
        };
        if (user.user_metadata?.preferred_username) payload.handle = user.user_metadata.preferred_username;
        await sb.from('profiles').upsert(payload, { onConflict: 'id' });
      }catch{}
    }

    async function handleNormal(){
      $('#normal').style.display = '';
      $('#title').textContent = 'Conectando con tu cuenta…';
      try{
        const errCode = getParam('error_code');
        const errDesc = getParam('error_description');
        if (errCode){
          $('#msg').textContent = 'El enlace no es válido o expiró.';
          $('#err').style.display = 'block';
          $('#err').textContent = (errDesc || errCode);
          return;
        }
        const { data: { session }, error } = await sb.auth.getSession();
        if (error) throw error;
        if (!session){
          $('#msg').textContent = 'No se obtuvo una sesión activa.';
          $('#err').style.display = 'block';
          $('#err').textContent = 'Abre el enlace desde el mismo navegador.';
          return;
        }
        await upsertProfile(session.user);
        $('#msg').textContent = 'Sesión activa.';
        $('#note').style.display = 'block';
        $('#note').textContent = '¡Bienvenido! Redirigiendo…';
        setTimeout(()=>location.replace(returnTo()), 600);
      }catch(e){
        $('#msg').textContent = 'Error procesando el inicio de sesión.';
        $('#err').style.display = 'block';
        $('#err').textContent = (e && e.message) ? e.message : String(e);
      }
    }

    async function handleRecovery(){
      $('#recovery').style.display = '';
      $('#title').textContent = 'Cambiar contraseña';
      $('#msg').textContent = 'Validando enlace…';

      try{
        // Asegura la sesión de recuperación
        const { data:{ session }, error } = await sb.auth.getSession();
        if (error) throw error;
        if (!session){
          $('#msg').textContent = 'No hay sesión de recuperación. Vuelve a solicitar el enlace.';
          return;
        }
        $('#msg').textContent = 'Sesión validada. Escribe tu nueva contraseña.';

        $('#setPwd').onclick = async ()=>{
          const p1 = $('#pwd1').value.trim();
          const p2 = $('#pwd2').value.trim();
          $('#recErr').style.display = 'none';
          $('#recNote').style.display = 'none';

          if (p1.length < 8) { $('#recErr').textContent='Mínimo 8 caracteres.'; $('#recErr').style.display='block'; return; }
          if (p1 !== p2)    { $('#recErr').textContent='Las contraseñas no coinciden.'; $('#recErr').style.display='block'; return; }

          try{
            const { error: uErr } = await sb.auth.updateUser({ password: p1 });
            if (uErr) throw uErr;
            $('#recNote').textContent = 'Contraseña actualizada. Redirigiendo…';
            $('#recNote').style.display = 'block';
            setTimeout(()=> location.replace('./profile.html'), 800);
          }catch(e){
            $('#recErr').textContent = e.message || 'No se pudo actualizar la contraseña.';
            $('#recErr').style.display = 'block';
          }
        };

        $('#cancel').onclick = ()=> location.replace(returnTo());
      }catch(e){
        $('#msg').textContent = 'No se pudo validar el enlace.';
        $('#recovery').style.display = 'none';
        $('#normal').style.display = '';
        $('#err').textContent = e.message || String(e);
        $('#err').style.display = 'block';
      }
    }

    (async function main(){
      if (!sb){
        $('#title').textContent='No hay cliente de Supabase';
        $('#msg').textContent='Abre Entrar y vuelve a intentarlo.';
        return;
      }
      if (isRecovery()) await handleRecovery();
      else await handleNormal();
    })();
  </script>
</body>
</html>
