<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PeekPay — Revisión de solicitudes (Fase 0)</title>
  <link rel="icon" href="/public/favicon.ico">
  <script defer data-domain="peak-pay.vercel.app" src="https://plausible.io/js/script.js"></script>
  <style>
    :root{--bg:#fff;--text:#0b1020;--muted:#475569;--card:#f8fafc;--ring:#e2e8f0;
          --cta:#111827;--ok:#059669;--err:#b91c1c;--warn:#d97706}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Arial,sans-serif;margin:0;background:var(--bg);color:var(--text)}
    .wrap{max-width:1120px;margin:0 auto;padding:24px 12px 64px}
    header{display:flex;gap:10px;align-items:center}
    header img{width:36px;height:36px;border-radius:8px}
    .brand small{color:var(--muted)}
    .btn{border:1px solid var(--cta);background:var(--cta);color:#fff;padding:8px 12px;border-radius:10px;cursor:pointer}
    .btn.ghost{background:#fff;color:var(--cta);border-color:var(--ring)}
    .btn.warn{background:var(--warn);border-color:var(--warn)}
    .btn.err{background:var(--err);border-color:var(--err)}
    .btn.ok{background:var(--ok);border-color:var(--ok)}
    .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin:8px 0 12px}
    .panel{border:1px solid var(--ring);background:var(--card);border-radius:16px;padding:14px}
    .cols{display:grid;grid-template-columns:320px 1fr;gap:12px}
    @media (max-width:960px){ .cols{grid-template-columns:1fr} }
    .list{display:flex;flex-direction:column;gap:8px}
    .pill{font-size:12px;border:1px solid var(--ring);background:#fff;border-radius:999px;padding:6px 10px}
    .pill.active{background:#111827;color:#fff;border-color:#111827}
    .card{border:1px solid var(--ring);background:#fff;border-radius:12px;padding:10px;cursor:pointer}
    .card.sel{outline:2px solid #111827}
    .muted{color:var(--muted)}
    input,select,textarea{width:100%;padding:8px 10px;border-radius:10px;border:1px solid var(--ring);background:#fff;font:inherit}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:8px}
    .row3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:8px}
    .kv{display:flex;justify-content:space-between;gap:12px;border:1px solid var(--ring);background:#fff;border-radius:10px;padding:8px 10px}
    .toast{margin-top:8px;font-size:13px}
    .toast.ok{color:var(--ok)} .toast.err{color:var(--err)}
    .right-actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .gear{font-size:18px;line-height:1;border-radius:10px;padding:6px 10px;border:1px solid var(--ring);background:#fff;cursor:pointer}
    .badge{display:inline-block;font-size:11px;border:1px solid var(--ring);border-radius:999px;padding:2px 8px;background:#fff}
    .badge.approved{background:#e8faf0;border-color:#b7e4c7}
    .badge.denied{background:#fde2e2;border-color:#f5c2c7}
    .badge.pending{background:#f3f4f6}
    .danger{color:var(--err)}
    .cfg{display:none;gap:8px;align-items:center}
    .cfg.show{display:flex}
  </style>
</head>
<body>
<div class="wrap">
  <div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
    <header>
      <img src="/public/peak1.PNG" alt="PeekPay">
      <div class="brand">
        <div><b>Revisión de solicitudes (Fase 0)</b></div>
        <small>Bandeja local; decisiones y log se guardan en este dispositivo.</small>
      </div>
    </header>
    <div class="toolbar">
      <a class="btn ghost" href="./index.html">Inicio</a>
      <button id="btnLoadAPI" class="btn">Cargar de API</button>
      <button id="btnImport" class="btn ghost">Importar JSON</button>
      <button id="btnExportLog" class="btn ghost">Exportar log</button>
      <button id="btnCSV" class="btn ghost">CSV</button>
      <button id="btnExportInbox" class="btn ghost">Exportar bandeja</button>
      <button id="btnRestoreInbox" class="btn ghost">Restaurar bandeja</button>
      <button id="btnClear" class="btn err">Vaciar</button>
      <button id="btnCfg" class="gear" title="Config API">⚙️</button>
    </div>
  </div>

  <div id="cfg" class="cfg panel">
    <div style="flex:1">
      <label style="font-size:12px" class="muted">API Base</label>
      <input id="apiBase" placeholder="http://localhost:8787">
    </div>
    <div style="flex:1">
      <label style="font-size:12px" class="muted">ADMIN_TOKEN</label>
      <input id="adminToken" placeholder="dev-admin">
    </div>
    <button id="btnSaveCfg" class="btn ok">Guardar</button>
  </div>

  <div class="cols">
    <!-- BANDEJA -->
    <section class="panel">
      <div class="list" style="margin-bottom:8px">
        <div style="display:flex;gap:6px;flex-wrap:wrap">
          <button class="pill active" data-tab="all">Todos (<span id="countAll">0</span>)</button>
          <button class="pill" data-tab="pending">Pendientes (<span id="countPending">0</span>)</button>
          <button class="pill" data-tab="approved">Aprobados (<span id="countApproved">0</span>)</button>
          <button class="pill" data-tab="denied">Denegados (<span id="countDenied">0</span>)</button>
        </div>
        <input id="q" placeholder="Buscar: handle, nombre, email...">
        <div>
          <small class="muted">En pantalla con filtro/búsqueda: <b id="countFiltered">0</b></small>
          <input id="noteAll" placeholder="Nota para todos (opcional)" style="margin-top:6px">
          <div style="display:flex;gap:6px;margin-top:6px">
            <button id="btnApproveFiltered" class="btn ok">Aprobar filtro</button>
            <button id="btnDenyFiltered" class="btn err">Denegar filtro</button>
            <button id="btnUndo" class="btn ghost">Deshacer</button>
          </div>
        </div>
      </div>
      <div id="list" class="list"></div>
      <div id="leftToast" class="toast"></div>
    </section>

    <!-- DETALLE -->
    <section class="panel">
      <h3>Detalle</h3>
      <div id="detail" class="muted">Selecciona una solicitud.</div>
      <div class="right-actions">
        <button id="btnApprove" class="btn ok" disabled>Aprobar</button>
        <button id="btnDeny" class="btn err" disabled>Denegar</button>
      </div>
      <div id="rightToast" class="toast"></div>
    </section>
  </div>
</div>

<script>
(function(){
  // ====== Estado ======
  const INBOX_KEY = 'pp_review_inbox_v2';
  const LOG_KEY   = 'pp_review_log_v2';
  const API_BASE_KEY = 'pp_api_base';
  const ADMIN_TOKEN_KEY = 'pp_admin_token';

  let API_BASE = localStorage.getItem(API_BASE_KEY) || 'http://localhost:8787';
  let ADMIN_TOKEN = localStorage.getItem(ADMIN_TOKEN_KEY) || 'dev-admin';

  const $ = s=>document.querySelector(s);
  const $$ = s=>Array.from(document.querySelectorAll(s));

  let inbox = loadInbox();
  let tab = 'all';
  let selId = null;
  let undo = null;

  // ====== Util ======
  function esc(s){return (s==null?'':String(s)).replace(/[&<>"]/g,c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c]));}
  function saveInbox(){ localStorage.setItem(INBOX_KEY, JSON.stringify(inbox)); }
  function loadInbox(){ try{ return JSON.parse(localStorage.getItem(INBOX_KEY)) || []; }catch{ return []; } }
  function log(action, item, extra={}) {
    const row = {ts:new Date().toISOString(), action, id:item?.id||null, handle:item?.account?.handle||'', extra};
    const arr = JSON.parse(localStorage.getItem(LOG_KEY)||'[]'); arr.push(row);
    localStorage.setItem(LOG_KEY, JSON.stringify(arr));
  }
  function toast(side,msg,type='ok'){ const el = side==='left' ? $('#leftToast'):$('#rightToast'); el.textContent = msg; el.className = 'toast ' + (type==='err'?'err':'ok'); setTimeout(()=>{el.textContent='';},1600); }

  function counts(){
    const all = inbox.length;
    const pending = inbox.filter(i=> (i.status||'pending')==='pending').length;
    const approved = inbox.filter(i=> i.status==='approved').length;
    const denied   = inbox.filter(i=> i.status==='denied').length;
    $('#countAll').textContent = all; $('#countPending').textContent = pending;
    $('#countApproved').textContent = approved; $('#countDenied').textContent = denied;
  }

  // ====== Render ======
  function render(){
    counts();
    const q = $('#q').value.toLowerCase().trim();
    const rows = inbox.filter(i=>{
      if (tab==='pending' && (i.status||'pending')!=='pending') return false;
      if (tab==='approved' && i.status!=='approved') return false;
      if (tab==='denied' && i.status!=='denied') return false;
      if (!q) return true;
      const s = JSON.stringify(i).toLowerCase();
      return s.includes(q);
    });
    $('#countFiltered').textContent = rows.length;

    const html = rows.map(i=>`
      <div class="card ${i.id===selId?'sel':''}" data-id="${esc(i.id)}">
        <div style="display:flex;justify-content:space-between;gap:6px">
          <div><b>@${esc(i.account?.handle||'')}</b> · <span class="muted">${esc(i.account?.email||'')}</span></div>
          <span class="badge ${esc(i.status||'pending')}">${esc(i.status||'pending')}</span>
        </div>
        <div class="muted" style="margin-top:2px">${esc(i.identity?.firstName||'')} ${esc(i.identity?.lastName||'')} · ${esc(i.identity?.country||'')}</div>
      </div>
    `).join('');
    $('#list').innerHTML = html || `<div class="muted">No hay solicitudes. Desde el formulario, pulsa “Enviar a bandeja (local)”.</div>`;

    // detalle
    const cur = inbox.find(x=>x.id===selId) || null;
    if (!cur){
      $('#detail').innerHTML = `<div class="muted">Selecciona una solicitud.</div>`;
      $('#btnApprove').disabled = true; $('#btnDeny').disabled = true;
    } else {
      $('#detail').innerHTML = renderDetail(cur);
      $('#btnApprove').disabled = false; $('#btnDeny').disabled = false;
    }

    // attach
    $$('#list .card').forEach(c=>c.onclick=()=>{ selId = c.dataset.id; render(); });
    const ta = $('#noteAll'); if (ta) ta.oninput = ()=>{/* nota masiva opcional */};
  }

  function renderDetail(i){
    const lines = [
      ['Email', `${i.account?.email||'—'} ${i.account?.emailVerified?'(verificado)':''}`],
      ['Teléfono', `${i.account?.phone||'—'} ${i.account?.phoneVerified?'(verificado)':''}`],
      ['Handle', '@'+(i.account?.handle||'')],
      ['Nombre', [i.identity?.firstName,i.identity?.lastName].filter(Boolean).join(' ')||'—'],
      ['País', i.identity?.country||'—'],
      ['DOB', i.identity?.dob||'—'],
      ['Doc', [i.identity?.idDoc?.type||'—', i.identity?.idDoc?.front?'frente':'', i.identity?.idDoc?.back?'reverso':''].filter(Boolean).join(' · ')],
      ['Selfie', i.identity?.selfie?'sí':'—'],
      ['Nombre público', i.profile?.displayName||'—'],
      ['Categorías', (i.profile?.categories||[]).join(', ')||'—'],
      ['Links', (i.profile?.links||[]).join(', ')||'—'],
      ['Pagos', [i.payouts?.method||'—', i.payouts?.country||'', i.payouts?.currency||'', i.payouts?.status||''].filter(Boolean).join(' · ')],
      ['2FA', i.security?.twoFA||'—'],
      ['Score', String(i.autoReview?.score ?? i.review?.score ?? '—')],
      ['Estado', (i.status||'pending')],
    ];
    return `
      ${lines.map(([k,v])=>`<div class="kv"><div>${esc(k)}</div><div style="opacity:.85">${esc(v)}</div></div>`).join('')}
      <div style="margin-top:8px">
        <label class="muted" style="font-size:12px">Notas</label>
        <textarea id="notes" placeholder="Notas para esta solicitud..." style="margin-top:6px">${esc((i.notes||[]).join('\n'))}</textarea>
      </div>
    `;
  }

  // ====== Acciones ======
  function applyDecision(ids, decision){
    if (!ids.length) return;
    const noteMass = $('#noteAll').value.trim();
    ids.forEach(id=>{
      const it = inbox.find(x=>x.id===id); if (!it) return;
      it.status = decision==='approve' ? 'approved' : 'denied';
      it.review = it.review || {};
      it.review.verdict = decision;
      it.review.decidedAt = new Date().toISOString();
      it.notes = it.notes || [];
      if (noteMass) it.notes.push(noteMass);
    });
    undo = {ids, to: decision};
    saveInbox(); render();
  }

  async function sendDecisionToAPI(id, decision){
    const item = inbox.find(x=>x.id===id);
    if (!item) return {ok:false,msg:'No encontrado en bandeja'};
    try{
      const r = await fetch(`${API_BASE}/api/submissions/${encodeURIComponent(id)}/decision`, {
        method:'POST',
        headers:{'Content-Type':'application/json','Authorization':`Bearer ${ADMIN_TOKEN}`},
        body: JSON.stringify({ verdict: decision, notes: item.notes||[] })
      });
      if (!r.ok){ const t=await r.text(); throw new Error(`HTTP ${r.status} ${t}`); }
      const js = await r.json();
      log('api_decision', item, {verdict:decision});
      return {ok:true, data:js};
    }catch(err){
      return {ok:false,msg:String(err.message||err)};
    }
  }

  async function loadFromAPI(){
    try{
      const r = await fetch(`${API_BASE}/api/submissions`);
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      const js = await r.json();
      const items = Array.isArray(js.items) ? js.items : [];
      // fusionar por id
      const map = new Map(inbox.map(i=>[i.id,i]));
      for (const it of items){
        const cur = map.get(it.id);
        map.set(it.id, cur ? {...cur, ...it} : it);
      }
      inbox = Array.from(map.values());
      saveInbox(); render();
      toast('right','Bandeja actualizada desde API','ok');
    }catch(err){
      toast('right','No se pudo cargar desde API','err');
      console.error(err);
    }
  }

  // ====== Toolbar & botones ======
  $('#btnCfg').onclick = ()=>{ $('#cfg').classList.toggle('show'); $('#apiBase').value = API_BASE; $('#adminToken').value = ADMIN_TOKEN; };
  $('#btnSaveCfg').onclick = ()=>{
    API_BASE = $('#apiBase').value.trim() || API_BASE;
    ADMIN_TOKEN = $('#adminToken').value.trim() || ADMIN_TOKEN;
    localStorage.setItem(API_BASE_KEY, API_BASE);
    localStorage.setItem(ADMIN_TOKEN_KEY, ADMIN_TOKEN);
    $('#cfg').classList.remove('show');
    toast('right','Config guardada','ok');
  };

  $('#btnLoadAPI').onclick = loadFromAPI;

  $('#btnImport').onclick = async ()=>{
    const inp = document.createElement('input'); inp.type='file'; inp.accept='.json,application/json'; inp.onchange=async ()=>{
      const f = inp.files[0]; if (!f) return;
      const js = JSON.parse(await f.text());
      const arr = Array.isArray(js) ? js : (Array.isArray(js.items) ? js.items : []);
      if (!arr.length){ toast('right','JSON vacío','err'); return; }
      inbox = arr; saveInbox(); render(); toast('right','Bandeja importada','ok');
    }; inp.click();
  };

  $('#btnExportInbox').onclick = ()=>{
    const blob = new Blob([JSON.stringify(inbox,null,2)],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='bandeja.json'; a.click(); URL.revokeObjectURL(a.href);
  };
  $('#btnRestoreInbox').onclick = ()=>{ inbox = loadInbox(); render(); toast('right','Bandeja restaurada','ok'); };
  $('#btnClear').onclick = ()=>{ inbox=[]; saveInbox(); render(); toast('right','Bandeja vaciada','ok'); };

  $('#btnExportLog').onclick = ()=>{
    const logData = localStorage.getItem(LOG_KEY)||'[]';
    const blob = new Blob([logData],{type:'application/json'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='review-log.json'; a.click(); URL.revokeObjectURL(a.href);
  };
  $('#btnCSV').onclick = ()=>{
    const rows = [['id','handle','email','name','country','status','score']];
    inbox.forEach(i=>rows.push([
      i.id, i.account?.handle||'', i.account?.email||'',
      `${i.identity?.firstName||''} ${i.identity?.lastName||''}`.trim(),
      i.identity?.country||'',
      i.status||'pending',
      String(i.autoReview?.score ?? i.review?.score ?? '')
    ]));
    const csv = rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(',')).join('\n');
    const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([csv],{type:'text/csv'})); a.download='bandeja.csv'; a.click(); URL.revokeObjectURL(a.href);
  };

  // tabs, búsqueda
  $$('.pill').forEach(p=>p.onclick=()=>{
    $$('.pill').forEach(x=>x.classList.remove('active'));
    p.classList.add('active'); tab = p.dataset.tab; render();
  });
  $('#q').oninput = ()=>render();

  // acciones masivas
  $('#btnApproveFiltered').onclick = async ()=>{
    const ids = getFilteredIds();
    applyDecision(ids,'approve'); toast('left',`Aprobadas ${ids.length}`,'ok');
    // enviar a API una por una
    for (const id of ids){ await sendDecisionToAPI(id,'approve'); }
  };
  $('#btnDenyFiltered').onclick = async ()=>{
    const ids = getFilteredIds();
    applyDecision(ids,'deny'); toast('left',`Denegadas ${ids.length}`,'ok');
    for (const id of ids){ await sendDecisionToAPI(id,'deny'); }
  };
  $('#btnUndo').onclick = ()=>{
    if (!undo){ toast('left','Nada para deshacer','err'); return; }
    const to = undo.to==='approve'?'pending':'pending';
    undo.ids.forEach(id=>{ const it=inbox.find(x=>x.id===id); if(it){ it.status='pending'; it.review={...it.review, verdict:'manual_review'}; } });
    undo=null; saveInbox(); render(); toast('left','Deshecho','ok');
  };

  function getFilteredIds(){
    const q = $('#q').value.toLowerCase().trim();
    return inbox
      .filter(i=>{
        if (tab==='pending' && (i.status||'pending')!=='pending') return false;
        if (tab==='approved' && i.status!=='approved') return false;
        if (tab==='denied' && i.status!=='denied') return false;
        if (!q) return true; return JSON.stringify(i).toLowerCase().includes(q);
      })
      .map(i=>i.id);
  }

  // acciones detalle
  $('#btnApprove').onclick = async ()=>{
    if (!selId) return;
    syncNotes(selId);
    applyDecision([selId],'approve');
    const r = await sendDecisionToAPI(selId,'approve');
    toast('right', r.ok?'Aprobada y enviada a API':'Aprobada (falló envío a API)', r.ok?'ok':'err');
  };
  $('#btnDeny').onclick = async ()=>{
    if (!selId) return;
    syncNotes(selId);
    applyDecision([selId],'deny');
    const r = await sendDecisionToAPI(selId,'deny');
    toast('right', r.ok?'Denegada y enviada a API':'Denegada (falló envío a API)', r.ok?'ok':'err');
  };
  function syncNotes(id){
    const it = inbox.find(x=>x.id===id); if (!it) return;
    const val = ($('#notes')?.value||'').trim();
    it.notes = val ? val.split('\n').map(s=>s.trim()).filter(Boolean) : [];
    saveInbox();
  }

  // ====== Init ======
  render();
  // Trae de API al abrir (si la API está viva)
  loadFromAPI(); // si falla, sólo queda en local
})();
</script>
</body>
</html>
