<!doctype html>
<html lang="es">
<head>
  <link rel="stylesheet" href="/public/styles.css">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PeekPay — Wallet</title>

  <link rel="icon" href="/public/favicon.ico">
  <style>
    :root{
      /* Base claros */
      --bg:#ffffff; --text:#0b1020; --muted:#475569; --card:#f8fafc; --ring:#e2e8f0;
      --ok:#059669; --err:#b91c1c;

      /* Marca (alineado con peek.html) */
      --indigo:#4f46e5; --indigo-ink:#3730a3; --indigo-soft:#eef2ff;
      --blue:#2563eb; --mint:#10b981; --mint-soft:#ecfdf5; --pink:#ec4899;

      /* Componentes */
      --cta: var(--indigo);
      --cta-text:#fff;
      --badge-bg: var(--indigo-soft);
      --badge-ring:#c7d2fe;
      --badge-text:#1e1b4b;
    }

    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Arial,sans-serif;margin:0;background:var(--bg);color:var(--text)}
    .wrap{max-width:940px;margin:0 auto;padding:28px 16px 56px}

    header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
    header .back{
      border:1px solid transparent;
      background: linear-gradient(90deg, var(--indigo) 0%, var(--blue) 100%);
      color:#fff;border-radius:10px;padding:8px 12px;text-decoration:none;
      box-shadow: 0 6px 16px rgba(79,70,229,.25);
    }
    header .back:hover{ filter: brightness(1.05) }

    .panel{
      border:1px solid var(--ring);
      background: var(--card);
      border-radius:16px;
      padding:14px;margin-top:12px;
      box-shadow: 0 6px 14px rgba(79,70,229,.06);
    }

    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

    .badge{
      font-size:12px;border:1px solid var(--badge-ring);background:var(--badge-bg);color:var(--badge-text);
      border-radius:10px;padding:6px 10px;line-height:1
    }
    .muted{color:var(--muted);font-size:12px}
    .h2{font-weight:700;margin:0 0 8px 0}

    .btn{
      border:0;background: linear-gradient(90deg, var(--indigo) 0%, var(--blue) 100%);
      color:#fff;border-radius:10px;padding:10px 14px;cursor:pointer;
      box-shadow: 0 6px 16px rgba(79,70,229,.25);
    }
    .btn:hover{ filter: brightness(1.05) }
    .btn.secondary{ background:#fff; color:var(--indigo); border:1px solid var(--ring); box-shadow:none }
    .btn[disabled]{opacity:.6;cursor:not-allowed}

    .grid{display:grid;grid-template-columns:repeat(3,minmax(0,1fr));gap:10px}
    .pack{
      border:1px solid var(--ring);
      background:#fff; color:var(--text); border-radius:14px; padding:14px; cursor:pointer; text-align:center;
      box-shadow: 0 6px 14px rgba(79,70,229,.06);
      transition: transform .06s ease, box-shadow .2s ease, border-color .2s ease;
    }
    .pack:hover{ transform: translateY(-1px); box-shadow: 0 12px 32px rgba(79,70,229,.10); border-color: color-mix(in srgb, var(--indigo) 30%, var(--ring)); }
    .pack small{ display:block; opacity:.75 }

    .msg{margin-top:8px;font-size:13px;min-height:18px}
    .ok{color:var(--ok)} .err{color:var(--err)}

    /* Historial */
    .hist{display:flex;flex-direction:column;gap:8px;margin-top:8px}
    .item{
      display:flex;justify-content:space-between;align-items:center;gap:12px;
      border:1px solid var(--ring); background:#fff; border-radius:12px; padding:12px;
      box-shadow: 0 6px 14px rgba(79,70,229,.06);
    }
    .left{display:flex;flex-direction:column;gap:2px}
    .title{font-weight:600}
    .sub{font-size:12px;color:var(--muted)}
    .pill{
      display:inline-block;font-size:11px;border:1px solid #e5e7eb;background:#f8fafc;color:#0b1020;
      border-radius:999px;padding:3px 8px;margin-right:6px
    }
    .cr-pos{color:var(--ok);font-weight:700}
    .cr-neg{color:var(--err);font-weight:700}

    /* Racha / progreso */
    .streak{display:flex;align-items:center;gap:10px;flex-wrap:wrap;margin-top:10px}
    .bar{flex:1;height:8px;background:#e5e7eb;border-radius:999px;overflow:hidden;min-width:160px}
    .bar>span{display:block;height:100%;background: linear-gradient(90deg, var(--indigo) 0%, var(--blue) 100%);width:0%}
    .streak .tips{font-size:12px;color:var(--muted)}

    @media (max-width: 720px){ .grid{ grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1 style="margin:0;font-size:18px">Wallet</h1>
      <a id="backBtn" class="back" href="#">Volver al Peek</a>
    </header>

    <section class="panel">
      <div class="row">
        <div class="badge">Peak Credits: <b id="credits">0</b> <span id="creditsUsd" class="muted" style="margin-left:6px">≈ $0.00</span></div>
        <div class="badge">Puntos: <b id="points">0</b></div>
        <div class="badge">Racha: <b id="streak">—</b></div>
      </div>

      <div class="streak">
        <div class="bar" aria-label="Progreso racha 7 días"><span id="streakBar"></span></div>
        <button id="claimBtn" class="btn">Reclamar bono diario</button>
        <button id="weeklyBtn" class="btn secondary">Bono semanal</button>
        <span id="streakHint" class="tips"></span>
        <span id="weeklyHint" class="tips"></span>
      </div>

      <div class="muted" style="margin-top:8px">
        UID: <span id="uid">—</span>
      </div>
    </section>

    <section class="panel">
      <h2 class="h2">Recargas <small class="muted">(alpha)</small></h2>
      <div class="grid">
        <button class="pack" data-pack="5">
          $5 → <b>+20</b> créditos
          <small>1 punto por $1</small>
        </button>
        <button class="pack" data-pack="10">
          $10 → <b>+50</b> créditos
          <small>1 punto por $1</small>
        </button>
        <button class="pack" data-pack="20">
          $20 → <b>+120</b> créditos
          <small>1 punto por $1</small>
        </button>
      </div>
      <div id="msg" class="msg"></div>
    </section>

    <section class="panel">
      <div class="row" style="justify-content:space-between">
        <h2 class="h2" style="margin:0">Historial <small class="muted">(recargas, desbloqueos y bonos)</small></h2>
        <div class="row">
          <button id="exportBtn" class="btn secondary">Exportar</button>
          <button id="importBtn" class="btn secondary" disabled>Importar</button>
        </div>
      </div>
      <div id="hist" class="hist"></div>
    </section>
  </div>

  <script>
    function $(s){ return document.querySelector(s); }

    /* ===== Config ===== */
    var API_BASE = (localStorage.getItem('pp_api_base')||'').replace(/\/+$/,'');
    var PP_UID = localStorage.getItem('pp_uid') || 'test-user-123';
    localStorage.setItem('pp_uid', PP_UID);

    function fmtMoney(v){
      try{ return Number(v).toLocaleString('en-US',{style:'currency',currency:'USD',minimumFractionDigits:2,maximumFractionDigits:2}); }
      catch(e){ return '$' + Number(v||0).toFixed(2); }
    }

    /* ===== UI helpers ===== */
    function setMsg(text, kind){
      var el = $('#msg');
      el.textContent = text || '';
      el.className = 'msg ' + (kind||'');
    }

    function updateTop(balance, points){
      if (typeof balance === 'number'){
        $('#credits').textContent = balance.toLocaleString('en-US');
        // $0.25 por crédito (ajusta si usas otro ratio)
        $('#creditsUsd').textContent = '≈ ' + fmtMoney(balance*0.25);
        localStorage.setItem('pp_demo_balance', String(balance));
      }
      if (typeof points === 'number'){
        $('#points').textContent = points.toLocaleString('en-US');
        localStorage.setItem('pp_points', String(points));
      }
      $('#uid').textContent = PP_UID;
    }

    function updateWeeklyHint(streakDays){
      var h = $('#weeklyHint');
      if (!h) return;
      var mod = streakDays % 7;
      if (streakDays > 0 && mod === 0){
        h.textContent = '¡Listo para reclamar el bono semanal!';
      } else {
        var restan = 7 - (mod || 7);
        h.textContent = 'Te faltan ' + restan + ' día(s) para el bono semanal.';
      }
    }

    function updateStreakUI(streak_days, claimed_today){
      var daysNum = Number(streak_days || localStorage.getItem('pp_streak_days') || 0);
      $('#streak').textContent = String(daysNum);

      var within7 = (daysNum % 7) || (daysNum>0 ? 7 : 0);
      $('#streakBar').style.width = String((within7/7)*100) + '%';

      var btn = $('#claimBtn');
      var hint = $('#streakHint');
      if (claimed_today){
        btn.disabled = true;
        btn.textContent = 'Bono de hoy reclamado';
        hint.textContent = 'Vuelve mañana para seguir la racha.';
        setClaimedTodayLocal();
      } else {
        btn.disabled = false;
        btn.textContent = 'Reclamar bono diario';
        hint.textContent = '1 punto por día con actividad.';
      }
      localStorage.setItem('pp_streak_days', String(daysNum));
      updateWeeklyHint(daysNum);
    }

    /* ===== API helpers ===== */
    function apiGet(path){
      if (!API_BASE) return Promise.reject(new Error('API base no configurada'));
      return fetch(API_BASE + path, { headers:{ 'X-PP-UID': PP_UID }})
        .then(function(r){
          if(!r.ok) throw new Error('GET ' + path + ' ' + r.status);
          return r.json();
        });
    }

    function apiPost(path, body){
      if (!API_BASE) return Promise.reject(new Error('API base no configurada'));
      return fetch(API_BASE + path, {
        method:'POST',
        headers:{ 'Content-Type':'application/json', 'X-PP-UID': PP_UID },
        body: JSON.stringify(body||{})
      }).then(function(r){
        return r.json().catch(function(){ return {}; }).then(function(j){
          if(!r.ok){
            var err = new Error(j && j.error ? j.error : ('HTTP '+r.status));
            err.status = r.status; err.payload = j;
            throw err;
          }
          return j;
        });
      });
    }

    /* ===== Normalizadores ===== */
    function pickCredits(obj){
      if (!obj) return 0;
      if (typeof obj.credits === 'number') return obj.credits;
      if (typeof obj.balance === 'number') return obj.balance;
      if (obj.balance && typeof obj.balance.credits === 'number') return obj.balance.credits;
      return 0;
    }
    function pickPoints(obj){
      if (!obj) return 0;
      if (typeof obj.points === 'number') return obj.points;
      if (obj.balance && typeof obj.balance.points === 'number') return obj.balance.points;
      return 0;
    }

    /* ===== Balance ===== */
    function refreshBalance(){
      return apiGet('/api/credits/balance').then(function(j){
        var bal = pickCredits(j);
        var pts = pickPoints(j);
        updateTop(bal, pts);
      }).catch(function(){
        var demo = Number(localStorage.getItem('pp_demo_balance')||0);
        updateTop(demo, Number(localStorage.getItem('pp_points')||0));
      });
    }

    /* ===== Historial ===== */
    function fmtWhen(ts){
      try{ return new Date(ts).toLocaleString(); }catch(e){ return String(ts||''); }
    }

    function renderHistory(items){
      var cont = $('#hist');
      cont.innerHTML = '';
      if (!items || !items.length){
        cont.innerHTML = '<div class="muted">Sin movimientos recientes.</div>';
        return;
      }
      for (var i=0;i<items.length;i++){
        var it = items[i];
        var row = document.createElement('div'); row.className='item';
        var left = document.createElement('div'); left.className='left';
        var right = document.createElement('div');

        var when = fmtWhen(it.ts);
        var meta = it.meta || {};
        var htmlTitle = '';
        var htmlSub = '';
        var rightHTML = '';

        if (it.type === 'topup'){
          var added = Number(
            (it.credits_added ?? it.credits ?? it.amount ?? it.delta ?? 0)
          );
          var usd = (typeof it.usd === 'number') ? it.usd : (added * 0.25);
          var pts = Number(it.points ?? it.points_delta ?? Math.round(added/20) || 0);

          htmlTitle = '<span class="pill">Recarga</span> Pack $' + usd.toFixed(2);
          htmlSub   = when + ' · +' + added + ' cr' + (pts?(' · +' + pts + ' pts'):'');
          rightHTML = '<span class="cr-pos">+' + added + ' cr</span>';
        } else if (it.type === 'unlock'){
          var spent = -Math.abs(Number(it.credits_delta ?? it.credits ?? 1));
          htmlTitle = '<span class="pill">Desbloqueo</span> 1 celda';
          htmlSub   = when;
          rightHTML = '<span class="cr-neg">' + spent + ' cr</span>';
        } else if (it.type === 'streak_bonus' || it.type === 'streak-bonus'){
          var p = Number(it.points ?? it.points_delta ?? 1);
          htmlTitle = '<span class="pill">Bono diario</span>';
          htmlSub   = when + ' · +' + p + ' pts';
          rightHTML = '<span class="cr-pos">+' + p + ' pts</span>';
        } else if (it.type === 'weekly_streak_bonus'){
          var c = Number(it.credits||it.credits_added||0);
          var p2 = Number(it.points||it.points_delta||0);
          htmlTitle = '<span class="pill">Bono semanal</span> racha ' + (meta.streak_days||'') + ' días';
          htmlSub   = when + ' · +' + p2 + ' pts · +' + c + ' cr';
          rightHTML = '<div style="text-align:right"><div class="cr-pos">+'+c+' cr</div><div class="sub">+'+p2+' pts</div></div>';
        } else {
          htmlTitle = '<span class="pill">Otro</span>';
          htmlSub   = when;
          rightHTML = '';
        }

        left.innerHTML = '<div class="title">' + htmlTitle + '</div><div class="sub">' + htmlSub + '</div>';
        right.innerHTML = rightHTML;

        row.appendChild(left); row.appendChild(right);
        cont.appendChild(row);
      }
    }

    function fetchHistory(limit){
      limit = limit || 20;
      return apiGet('/api/credits/history?limit=' + limit).then(function(j){
        return (j && j.items) ? j.items : [];
      });
    }

    function refreshHistory(){
      return fetchHistory(20).then(renderHistory).catch(function(){ renderHistory([]); });
    }

    /* ===== Puntos / Racha ===== */
    function refreshPoints(){
      // intenta endpoint de puntos; si falla, usa balance
      return apiGet('/api/credits/points').then(function(data){
        var totalPts = Number((data && data.points) || localStorage.getItem('pp_points') || 0);
        updateTop(undefined, totalPts);
        var sd = Number((data && data.streak_days) || localStorage.getItem('pp_streak_days') || 0);
        var ct = !!(data && data.claimed_today);
        updateStreakUI(sd, ct);
      }).catch(function(){
        var sd2 = Number(localStorage.getItem('pp_streak_days')||0);
        updateStreakUI(sd2, false);
      });
    }

    function mkReasonMsg(reason){
      if (reason==='already_granted') return 'Ya reclamaste el bono de hoy.';
      if (reason==='no_activity_today') return 'Aún no hay actividad hoy. Desbloquea un Peek y vuelve.';
      if (reason==='not_multiple_of_7') return 'Aún no completas 7 días seguidos.';
      return 'Bono no disponible por ahora.';
    }

    /* ===== (dedupe) helpers de fecha de reclamo local ===== */
    function todayKey(){ return new Date().toISOString().slice(0,10); } // YYYY-MM-DD
    function hasClaimedTodayLocal(){
      return localStorage.getItem('pp_streak_last_claim_date') === todayKey();
    }
    function setClaimedTodayLocal(){
      localStorage.setItem('pp_streak_last_claim_date', todayKey());
    }

    function onClaimDaily(){
      var btn = $('#claimBtn');
      if (hasClaimedTodayLocal()){
        setMsg('Ya reclamaste el bono de hoy.','err');
        updateStreakUI(localStorage.getItem('pp_streak_days')||0, true);
        return;
      }
      btn.disabled = true; btn.textContent = 'Reclamando…'; setMsg('');
      apiPost('/api/credits/streak-bonus', {})
        .then(function(res){
          if (res && res.ok && (res.granted || res.granted===true)){
            var current = Number(localStorage.getItem('pp_points')||0);
            var added = Number(res.points_awarded ?? res.points ?? 1);
            updateTop(undefined, current + added);
            setClaimedTodayLocal();
            setMsg('¡Bono diario reclamado! +' + added + ' punto' + (added>1?'s':'') + ' 🎉','ok');
          }else{
            var reason = (res && res.reason) || 'not_granted';
            if (reason === 'already_granted') setClaimedTodayLocal();
            setMsg(mkReasonMsg(reason),'err');
          }
        })
        .catch(function(err){
          if (err && err.status===409){
            var reason2 = (err.payload && err.payload.reason) || 'already_granted';
            if (reason2 === 'already_granted') setClaimedTodayLocal();
            setMsg(mkReasonMsg(reason2),'err');
          }else{
            setMsg('No se pudo reclamar el bono hoy.','err');
          }
        })
        .finally(function(){
          refreshBalance().then(refreshHistory).then(refreshPoints).finally(function(){
            btn.disabled = !!hasClaimedTodayLocal();
            btn.textContent = hasClaimedTodayLocal() ? 'Bono de hoy reclamado' : 'Reclamar bono diario';
          });
        });
    }

    function onClaimWeekly(){
      var b = $('#weeklyBtn');
      b.disabled = true; b.textContent = 'Reclamando…';
      apiPost('/api/credits/weekly-streak-bonus', {})
        .then(function(r){
          if (r && r.ok && r.granted){
            setMsg('¡Bono semanal! +' + (r.points_awarded||0) + ' pts y +' + (r.credits_awarded||0) + ' cr 🎉', 'ok');
          } else {
            setMsg(mkReasonMsg(r && r.reason), 'err');
          }
        })
        .catch(function(){
          setMsg('No se pudo reclamar el bono semanal.','err');
        })
        .finally(function(){
          refreshBalance().then(refreshHistory).then(refreshPoints).finally(function(){
            b.disabled=false; b.textContent='Bono semanal';
          });
        });
    }

    /* ===== Export CSV ===== */
    function toCSV(rows){
      function esc(v){
        if (v==null) return '';
        var s = String(v);
        return /[",\n]/.test(s) ? '"' + s.replace(/"/g,'""') + '"' : s;
      }
      var out = [];
      for (var i=0;i<rows.length;i++){
        var r = rows[i], cols = [];
        for (var j=0;j<r.length;j++) cols.push(esc(r[j]));
        out.push(cols.join(','));
      }
      return out.join('\n');
    }

    function onExport(){
      setMsg('Generando CSV…');
      fetchHistory(1000).then(function(items){
        var header = ['id','type','credits','usd','points','ts','source'];
        var rows = [header];
        for (var i=0;i<items.length;i++){
          var it = items[i];
          rows.push([
            it.id||'',
            it.type||'',
            (typeof it.credits==='number'?it.credits:(it.credits_added??'')),
            (typeof it.usd==='number'?it.usd:''),
            (typeof it.points==='number'?it.points:(it.points_delta??'')),
            it.ts||'',
            (it.meta && it.meta.source) || ''
          ]);
        }
        var csv = toCSV(rows);
        var blob = new Blob([csv], {type:'text/csv;charset=utf-8'});
        var url = URL.createObjectURL(blob);
        var a = document.createElement('a');
        a.href = url;
        a.download = 'wallet-history-' + PP_UID + '-' + new Date().toISOString().slice(0,10) + '.csv';
        document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
        setMsg('CSV exportado ✔️','ok');
      }).catch(function(){
        setMsg('No se pudo exportar el historial.','err');
      });
    }

    /* ===== Recargas ===== */
    function onTopupClick(e){
      var btn = e.currentTarget;
      var pack = Number(btn.getAttribute('data-pack'));
      if ([5,10,20].indexOf(pack)===-1){ setMsg('Pack inválido.','err'); return; }
      setMsg('Procesando recarga…');
      apiPost('/api/credits/topup', { pack:pack })
        .then(function(res){
          var added = Number(res.added ?? res.credits_added ?? res.amount ?? res.credits_delta ?? 0);
          var usd   = Number(res.usd ?? (added ? (added*0.25) : 0));
          var pts   = Number(localStorage.getItem('pp_points')||0) + Number(res.points ?? 0);
          updateTop(pickCredits(res), pts);
          return refreshBalance().then(refreshHistory).then(refreshPoints).then(function(){
            setMsg('Recarga exitosa: +' + added + ' cr (' + fmtMoney(usd) + ').', 'ok');
          });
        })
        .catch(function(){
          setMsg('No se pudo completar la recarga. Intenta de nuevo.','err');
        });
    }

    /* ===== Back ===== */
    (function(){
      var p = new URLSearchParams(location.search);
      var ret = p.get('return');
      var back = $('#backBtn');
      back.href = ret || './peek.html';
    })();

    /* ===== Wire UI ===== */
    var packsEls = document.querySelectorAll('.pack');
    for (var i=0;i<packsEls.length;i++){ packsEls[i].addEventListener('click', onTopupClick); }
    $('#exportBtn').onclick = onExport;
    $('#importBtn').onclick = function(){};
    $('#claimBtn').onclick = onClaimDaily;
    $('#weeklyBtn').onclick = onClaimWeekly;

    /* ===== Init ===== */
    (function init(){
      refreshBalance().then(refreshHistory).then(refreshPoints);
      startAutoRefresh(); // loop pasivo
      if (hasClaimedTodayLocal()){
        var b = $('#claimBtn');
        b.disabled = true; b.textContent = 'Bono de hoy reclamado';
      }
    })();

    /* ===== (auto-refresh) balance/puntos/historial sin recargar ===== */
    var BASE_REFRESH_MS = 60 * 1000;     // 60s por defecto
    var MAX_REFRESH_MS  = 5 * 60 * 1000; // backoff máximo 5min
    var refreshTimer = null;
    var currentDelay = BASE_REFRESH_MS;

    function scheduleNext(){
      clearTimeout(refreshTimer);
      var jitter = Math.floor(Math.random()*10000); // 0–10s
      refreshTimer = setTimeout(runRefreshTick, currentDelay + jitter);
    }

    function runRefreshTick(){
      if (document.hidden){ scheduleNext(); return; }
      Promise.all([
        refreshBalance(),
        refreshPoints(),
        refreshHistory()
      ]).then(function(){
        currentDelay = BASE_REFRESH_MS;
      }).catch(function(){
        currentDelay = Math.min(MAX_REFRESH_MS, currentDelay * 2);
      }).finally(scheduleNext);
    }

    function startAutoRefresh(){
      currentDelay = BASE_REFRESH_MS;
      scheduleNext();
    }

    document.addEventListener('visibilitychange', function(){
      if (!document.hidden){
        currentDelay = BASE_REFRESH_MS;
        runRefreshTick();
      }
    });
    window.addEventListener('focus', function(){
      currentDelay = BASE_REFRESH_MS;
      runRefreshTick();
    });
  </script>
</body>
</html>
