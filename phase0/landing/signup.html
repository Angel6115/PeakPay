<!doctype html>
<html lang="es">
<head>
  <link rel="stylesheet" href="/public/styles.css">
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PeekPay — Crea tu cuenta</title>

  <link rel="icon" href="/public/favicon.ico">
  <script defer data-domain="peak-pay.vercel.app" src="https://plausible.io/js/script.js"></script>

  <style>
    :root{
      --bg:#ffffff; --text:#0b1020; --muted:#475569; --card:#f8fafc; --ring:#e2e8f0;
      --ok:#059669; --err:#b91c1c;
      --indigo:#4f46e5; --blue:#2563eb; --indigo-soft:#eef2ff;
    }
    *{ box-sizing:border-box }
    body{ margin:0; background:var(--bg); color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Arial,sans-serif }
    .wrap{ max-width:820px; margin:0 auto; padding:28px 16px 64px }

    /* Header consistente */
    .head{ display:flex; align-items:center; gap:10px; }
    header img{ width:44px; height:44px; border-radius:12px; object-fit:cover; box-shadow:0 6px 14px rgba(79,70,229,.06) }
    .brand h1{ margin:0; font-size:18px }
    .brand p{ margin:0; color:var(--muted); font-size:12px }

    /* Panel / tarjeta */
    .panel{
      border:1px solid var(--ring); background:var(--card);
      border-radius:16px; padding:16px; margin-top:12px;
      box-shadow: 0 6px 14px rgba(79,70,229,.06);
    }

    .btn{
      border:0; background: linear-gradient(90deg, var(--indigo) 0%, var(--blue) 100%);
      color:#fff; border-radius:10px; padding:10px 14px; cursor:pointer; text-decoration:none;
      box-shadow: 0 6px 16px rgba(79,70,229,.25); white-space:nowrap; display:inline-block;
    }
    .btn:hover{ filter: brightness(1.05) }
    .btn.secondary{ background:#fff; color:var(--indigo); border:1px solid var(--ring); box-shadow:none }

    .form-grid{ display:grid; gap:12px }
    @media (min-width:800px){
      .form-grid{ grid-template-columns: 1fr 1fr; }
      .full{ grid-column: 1 / -1; }
    }

    .field{ display:flex; flex-direction:column; gap:6px }
    .field label{ font-size:13px; color:var(--muted) }
    .input, select{
      padding:12px 12px; border-radius:12px; border:1px solid var(--ring); background:#fff; color:var(--text);
      outline:none;
    }
    .input:focus, select:focus{ box-shadow:0 0 0 3px #dbeafe; border-color:#93c5fd }
    .hint{ font-size:12px; color:var(--muted) }

    /* Password meter */
    .meter{ height:8px; border-radius:999px; background:#e5e7eb; overflow:hidden; border:1px solid var(--ring) }
    .meter > span{ display:block; height:100%; width:0%; background:linear-gradient(90deg,#ef4444,#f59e0b,#22c55e); transition: width .25s ease }
    .meter-label{ font-size:12px; color:var(--muted) }

    .checks{ display:grid; gap:8px; margin-top:6px }
    .checks label{ display:flex; gap:8px; align-items:flex-start; font-size:13px; color:var(--text) }
    .checks input[type="checkbox"]{ margin-top:2px }

    .actions{ display:flex; gap:10px; flex-wrap:wrap; margin-top:8px }
    .msg{ font-size:13px; min-height:18px; margin-top:8px }
    .ok{ color:var(--ok) } .err{ color:var(--err) }

    .pill{
      display:inline-block; font-size:11px; padding:4px 8px; border-radius:999px;
      background:var(--indigo-soft); border:1px solid #c7d2fe; color:#1e1b4b;
    }

    .hr{ height:1px; background:var(--ring); margin:12px 0 }
    .small{ font-size:12px; color:var(--muted) }
  </style>
</head>
<body>
  <div class="wrap">
    <!-- Header -->
    <div class="head">
      <header><img src="/public/peak1.PNG" alt="PeekPay"></header>
      <div class="brand">
        <h1>PeekPay</h1>
        <p>Confidencialidad primero</p>
      </div>
    </div>

    <!-- Info seguridad -->
    <section class="panel">
      <h2 style="margin:0 0 8px; font-size:20px">Crea tu cuenta</h2>
      <p class="small">Minimizamos los datos: sólo solicitamos email, un alias (handle) y contraseña. No pedimos nombre real. Luego podrás activar 2FA.</p>
      <div class="hr"></div>

      <!-- Form -->
      <form id="signup" class="form-grid" novalidate>
        <!-- honeypot anti-bots -->
        <input type="text" name="website" autocomplete="off" tabindex="-1" aria-hidden="true" style="position:absolute; left:-9999px; width:1px; height:1px; opacity:0" />

        <!-- Rol -->
        <div class="field">
          <label for="role">¿Cómo deseas empezar?</label>
          <select id="role" name="role" class="input" required>
            <option value="" disabled selected>Selecciona tu rol</option>
            <option value="usuario">Usuario</option>
            <option value="creador">Creador/a</option>
            <option value="ambos">Ambos</option>
          </select>
          <span class="hint">Esto solo ajusta la experiencia inicial; podrás cambiarlo luego.</span>
        </div>

        <!-- Email -->
        <div class="field">
          <label for="email">Email (se usará para el login y verificación)</label>
          <input id="email" name="email" type="email" class="input" inputmode="email" autocomplete="email" required placeholder="tú@correo.com" />
          <span class="hint">Nunca compartimos tu email. Requerimos verificación.</span>
        </div>

        <!-- Handle -->
        <div class="field">
          <label for="handle">Alias público (@handle)</label>
          <input id="handle" name="handle" type="text" class="input" autocomplete="off" required placeholder="ej: luna.aria" />
          <span class="hint" id="handleHelp">Min 3 caracteres; letras, números, punto o guion bajo. No uses tu nombre real si buscas anonimato.</span>
        </div>

        <!-- Display name (opcional) -->
        <div class="field">
          <label for="display">Nombre para mostrar (opcional)</label>
          <input id="display" name="display" type="text" class="input" autocomplete="name" placeholder="Cómo quieres que te vean" />
        </div>

        <!-- Password -->
        <div class="field full">
          <label for="pass">Contraseña</label>
          <div style="display:flex; gap:8px; align-items:center">
            <input id="pass" name="pass" type="password" class="input" required autocomplete="new-password" placeholder="Mínimo 10 caracteres" style="flex:1" />
            <button type="button" id="toggle" class="btn secondary" aria-pressed="false" aria-label="Mostrar u ocultar contraseña">Ver</button>
          </div>
          <div class="meter" aria-hidden="true"><span id="meterBar"></span></div>
          <div class="meter-label" id="meterLabel">Fortaleza: —</div>
          <span class="hint">Recomendado: frases largas + mayúsculas + números + símbolos. Evita datos personales.</span>
        </div>

        <!-- Confirm -->
        <div class="field">
          <label for="confirm">Confirmar contraseña</label>
          <input id="confirm" name="confirm" type="password" class="input" required autocomplete="new-password" placeholder="Repite tu contraseña" />
        </div>

        <!-- País (opcional) -->
        <div class="field">
          <label for="country">País (opcional)</label>
          <input id="country" name="country" type="text" class="input" autocomplete="country-name" placeholder="País o región" />
        </div>

        <!-- Preferencias / seguridad -->
        <div class="field full">
          <span class="pill">Privacidad</span>
          <div class="checks">
            <label><input type="checkbox" id="age" required /> Confirmo que tengo 18+ años.</label>
            <label><input type="checkbox" id="terms" required /> Acepto los <a href="./terms.html" target="_blank" rel="noopener">Términos</a> y la <a href="./privacy.html" target="_blank" rel="noopener">Política de Privacidad</a>.</label>
            <label><input type="checkbox" id="news" /> Quiero recibir novedades (opcional).</label>
          </div>
        </div>

        <!-- Acciones -->
        <div class="actions full">
          <button type="submit" id="submitBtn" class="btn">Crear cuenta</button>
          <a class="btn secondary" href="./index.html">Volver</a>
        </div>

        <p id="msg" class="msg"></p>
        <p class="small full">Al registrarte, generaremos un ID interno seudónimo y ciframos contraseñas en el servidor con *hashing* de factor de trabajo. Los pagos aún no están habilitados en esta fase.</p>
      </form>
    </section>
  </div>

  <script>
    // ===== Config API base (como en las otras páginas)
    const API = (localStorage.getItem('pp_api_base')||'').replace(/\/+$/,'') || '';

    (function bootstrapRole(){
      try{
        const p = new URLSearchParams(location.search);
        const fromQS = p.get('role');
        const stored = localStorage.getItem('pp_signup_role');
        const role = fromQS || stored || '';
        if (role) document.getElementById('role').value = role;
      }catch(e){}
    })();

    const form = document.getElementById('signup');
    const msg  = document.getElementById('msg');
    const pass = document.getElementById('pass');
    const confirm = document.getElementById('confirm');
    const handle = document.getElementById('handle');
    const email = document.getElementById('email');
    const toggle = document.getElementById('toggle');
    const meterBar = document.getElementById('meterBar');
    const meterLabel = document.getElementById('meterLabel');
    const submitBtn = document.getElementById('submitBtn');
    const handleHelp = document.getElementById('handleHelp');

    function setMessage(text, ok){
      msg.textContent = text || '';
      msg.className = 'msg ' + (ok ? 'ok' : 'err');
    }

    // Validación de handle: a-z, 0-9, . _
    function validHandle(h){
      return /^[a-z0-9._]{3,30}$/.test(h);
    }

    // Password fuerte (alineado con backend: ≥10, mayus, minus, dígito)
    function strongPass(s){
      return s.length>=10 && /[A-Z]/.test(s) && /[a-z]/.test(s) && /\d/.test(s);
    }

    // Password score simple (0..4)
    function scorePassword(s){
      let score = 0;
      if (!s) return 0;
      if (s.length >= 10) score++;
      if (s.length >= 14) score++;
      if (/[a-z]/.test(s) && /[A-Z]/.test(s)) score++;
      if (/\d/.test(s)) score++;
      if (/[^a-zA-Z0-9]/.test(s)) score++;
      return Math.max(0, Math.min(4, score));
    }
    function updateMeter(){
      const s = pass.value || '';
      const sc = scorePassword(s);
      const widths = ['0%','25%','50%','75%','100%'];
      meterBar.style.width = widths[sc];
      const labels = ['Muy débil','Débil','Aceptable','Fuerte','Muy fuerte'];
      meterLabel.textContent = 'Fortaleza: ' + labels[sc];
    }
    pass.addEventListener('input', updateMeter);

    toggle.addEventListener('click', function(){
      const vis = pass.type === 'password' ? 'text' : 'password';
      pass.type = vis; confirm.type = vis;
      const pressed = this.getAttribute('aria-pressed') === 'true';
      this.setAttribute('aria-pressed', String(!pressed));
      this.textContent = vis === 'text' ? 'Ocultar' : 'Ver';
    });

    // ===== Validación en vivo de handle contra API
    let handleTimer;
    handle.addEventListener('input', function(){
      handleHelp.style.color = '';
      if (!validHandle(handle.value.trim().toLowerCase())){
        handleHelp.textContent = 'Alias inválido. Usa 3–30 caracteres: a–z, 0–9, punto o guion bajo.';
        handleHelp.style.color = '#b91c1c';
        return;
      }
      handleHelp.textContent = 'Comprobando disponibilidad…';
      clearTimeout(handleTimer);
      handleTimer = setTimeout(async ()=>{
        const h = handle.value.trim().toLowerCase();
        if (!API) { handleHelp.textContent = 'Disponible ✔️'; handleHelp.style.color = '#059669'; return; }
        try{
          const r = await fetch(API + '/api/auth/check-handle?handle=' + encodeURIComponent(h));
          const j = await r.json();
          if (j && j.available){ handleHelp.textContent = 'Disponible ✔️'; handleHelp.style.color = '#059669'; }
          else { handleHelp.textContent = 'No disponible'; handleHelp.style.color = '#b91c1c'; }
        }catch{
          // si falla red, no bloqueamos
          handleHelp.textContent = 'Disponible ✔️';
          handleHelp.style.color = '#059669';
        }
      }, 300);
    });

    // ===== Submit al backend
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      setMessage('');

      // Honeypot
      if (form.elements.website.value) return; // bot

      // Validaciones
      if (!form.role.value) return setMessage('Selecciona un rol.', false);
      if (!email.value || !/^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(email.value)) return setMessage('Email inválido.', false);
      const h = handle.value.trim().toLowerCase();
      if (!validHandle(h)) return setMessage('Alias inválido. Usa 3–30 caracteres: a–z, 0–9, punto o guion bajo.', false);
      if (!strongPass(pass.value)) return setMessage('Contraseña débil. Usa ≥10 caracteres con mayúsculas, minúsculas y números.', false);
      if (pass.value !== confirm.value) return setMessage('Las contraseñas no coinciden.', false);
      if (!document.getElementById('age').checked) return setMessage('Debes confirmar que eres mayor de 18 años.', false);
      if (!document.getElementById('terms').checked) return setMessage('Debes aceptar Términos y Privacidad.', false);

      // Si no hay API_BASE, hacemos fallback a gracias.html (modo demo)
      if (!API){
        try{ localStorage.setItem('pp_signup_role', form.role.value); }catch(e){}
        return (location.href = './gracias.html');
      }

      submitBtn.disabled = true; submitBtn.textContent = 'Creando…';

      const payload = {
        email: email.value.trim(),
        password: pass.value,
        handle: h,
        display_name: (document.getElementById('display').value || '').trim(),
        country: (document.getElementById('country').value || '').trim(),
        role: form.role.value
      };

      try{
        const r = await fetch(API + '/api/auth/signup', {
          method:'POST',
          headers:{ 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });
        const j = await r.json().catch(()=>({}));

        if (r.ok && j && j.ok){
          try{ localStorage.setItem('pp_signup_role', form.role.value); }catch(e){}
          location.href = './check-email.html';
        } else {
          const code = (j && j.error) || 'unknown';
          setMessage(mapSignupError(code), false);
        }
      }catch{
        setMessage('No se pudo crear la cuenta, intenta otra vez.', false);
      }finally{
        submitBtn.disabled = false; submitBtn.textContent = 'Crear cuenta';
      }
    });

    function mapSignupError(code){
      if (code==='email_in_use') return 'Ese correo ya está en uso.';
      if (code==='handle_taken') return 'Ese alias ya está tomado.';
      if (code==='weak_password') return 'La contraseña debe tener ≥10 caracteres con mayúsculas, minúsculas y números.';
      if (code==='invalid_handle') return 'Usa 3–30 caracteres: a–z, 0–9, “_” o “.”';
      if (code==='invalid_email') return 'Correo inválido.';
      if (code==='auth_error') return 'No se pudo crear la cuenta (auth).';
      if (code==='profile_error') return 'No se pudo guardar tu perfil.';
      return 'No se pudo completar el registro.';
    }

    // Tracking de intención
    document.querySelectorAll('.btn').forEach(b=>{
      b.addEventListener('click', ()=> {
        try{ if(window.plausible){ plausible('signup_cta', { props:{ label: b.textContent.trim() } }) } }catch(e){}
      });
    });
  </script>
</body>
</html>
