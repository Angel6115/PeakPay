<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
    <script src="./env.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="./_header.js" defer></script>  <title>PeekPay — Solicitud de Creador (Fase 0)</title>
  <link rel="icon" href="/favicon.ico">
  <script defer data-domain="peak-pay.vercel.app" src="https://plausible.io/js/script.js"></script>
  <style>
    :root{--bg:#fff;--text:#0b1020;--muted:#475569;--card:#f8fafc;--ring:#e2e8f0;--cta:#111827;--ok:#059669;--err:#b91c1c}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,Arial,sans-serif;margin:0;background:var(--bg);color:var(--text)}
    .wrap{max-width:1024px;margin:0 auto;padding:24px 12px 56px}
    header{display:flex;gap:10px;align-items:center}
    header img{width:36px;height:36px;border-radius:8px}
    .brand small{color:var(--muted)}
    .btn{border:1px solid var(--cta);background:var(--cta);color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer}
    .btn.ghost{background:#fff;color:var(--cta);border-color:var(--ring)}
    .btn.ok{background:var(--ok);border-color:var(--ok)}
    .btn.err{background:var(--err);border-color:var(--err)}
    .stepper{display:flex;gap:6px;flex-wrap:wrap;margin:12px 0}
    .step{font-size:12px;border:1px solid var(--ring);background:#fff;border-radius:999px;padding:6px 10px}
    .step.active{background:#111827;color:#fff;border-color:#111827}
    .panel{border:1px solid var(--ring);background:var(--card);border-radius:16px;padding:16px;margin-top:10px}
    .row{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:860px){ .row{grid-template-columns:1fr 1fr} }
    label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
    input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--ring);background:#fff;font:inherit}
    textarea{min-height:88px;resize:vertical}
    .grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px}
    .hint{font-size:12px;color:var(--muted)}
    .actions{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}
    .error{color:var(--err);font-size:13px;margin-top:6px}
    .okmsg{color:var(--ok);font-size:13px;margin-top:6px}
    .chips{display:flex;flex-wrap:wrap;gap:8px;margin-top:6px}
    .chip{font-size:12px;border:1px solid var(--ring);background:#fff;padding:6px 10px;border-radius:999px}
    .inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .review-line{display:flex;gap:8px;align-items:center;justify-content:space-between;border:1px solid var(--ring);background:#fff;border-radius:10px;padding:10px 12px;margin-top:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="inline" style="justify-content:space-between">
      <header>
        <img src="./peak1.png" alt="PeekPay">
        <div class="brand">
          <div><b>Creator Studio — Solicitud (Fase 0)</b></div>
          <small>Aplica como creador sin refrescar la página · listo para revisión</small>
        </div>
      </header>
      <a class="btn ghost" href="./index.html">Inicio</a>
    </div>

    <div class="stepper" id="stepper"></div>

    <section class="panel" id="step-content"></section>

    <div class="actions">
      <button class="btn ghost" id="btn-prev">← Atrás</button>
      <button class="btn" id="btn-next">Siguiente →</button>
      <button class="btn ok" id="btn-save" title="Guardar borrador en este dispositivo">Guardar borrador</button>
      <button class="btn err" id="btn-clear" title="Limpiar todo">Limpiar</button>
    </div>

    <p class="hint" style="margin-top:10px">
      * Fase 0: descargamos un JSON local con tu solicitud. En Fase 1 lo enviaremos a verificación (Stripe/Onfido) y activaremos onboarding de pagos.
    </p>
  </div>

<script>
(function(){
  const $ = s => document.querySelector(s);
  const $$ = s => Array.from(document.querySelectorAll(s));

  // === API base (mock) ===
  const API_BASE = 'http://localhost:8787';

  // ====== Estado ======
  const FORM_KEY = 'pp_onboarding_v1';
  const steps = [
    { k:'account',  name:'Cuenta',     render:renderAccount,  validate:validateAccount },
    { k:'identity', name:'Identidad',  render:renderIdentity, validate:validateIdentity },
    { k:'profile',  name:'Perfil',     render:renderProfile,  validate:validateProfile },
    { k:'payouts',  name:'Pagos',      render:renderPayouts,  validate:validatePayouts },
    { k:'security', name:'Seguridad',  render:renderSecurity, validate:()=>({ok:true}) },
    { k:'agreements',name:'Acuerdos',  render:renderAgreements,validate:validateAgreements },
    { k:'review',   name:'Revisión',   render:renderReview,   validate:()=>({ok:true}) },
  ];
  let idx = 0;
  let data = loadDraft() || getEmpty();

  function getEmpty(){
    return {
      account:{email:'',emailVerified:false,phone:'',phoneVerified:false,handle:'',locale:'es'},
      identity:{firstName:'',lastName:'',country:'',dob:'',idDoc:{type:'',front:'',back:''},selfie:''},
      profile:{displayName:'',bio:'',categories:[],links:[]},
      payouts:{method:'',country:'',currency:'',status:''},
      security:{twoFA:'sms'},
      agreements:{tosAccepted:false,contentAccepted:false,revShareAccepted:false,revSharePct:20},
      meta:{createdAt: new Date().toISOString(), source:'onboarding-local'}
    };
  }
  function saveDraft(){ localStorage.setItem(FORM_KEY, JSON.stringify(data)); toast('Borrador guardado', 'ok'); }
  function loadDraft(){ try{ return JSON.parse(localStorage.getItem(FORM_KEY)); }catch{ return null; } }
  function clearDraft(){ localStorage.removeItem(FORM_KEY); }

  // ====== UI base ======
  function render(){
    // stepper
    const s = steps.map((st,i)=>`<span class="step ${i===idx?'active':''}">${i+1}. ${st.name}</span>`).join('');
    $('#stepper').innerHTML = s;
    // contenido
    $('#step-content').innerHTML = steps[idx].render();
    // controles
    $('#btn-prev').disabled = idx===0;
    $('#btn-next').textContent = idx===steps.length-1 ? 'Descargar solicitud (JSON)' : 'Siguiente →';
    attachHandlers();
  }
  function next(){
    const val = steps[idx].validate();
    if (!val.ok){ toast(val.msg || 'Completa los campos requeridos', 'err'); return; }
    if (idx===steps.length-1){
      downloadJSON();
      return;
    }
    idx++; render();
  }
  function prev(){ if(idx>0){ idx--; render(); } }
  function toast(msg, type='ok'){ const el=document.createElement('div'); el.className= type==='err'?'error':'okmsg'; el.textContent=msg; $('#step-content').appendChild(el); setTimeout(()=>el.remove(),1800); }

  // ====== Renders por paso ======
  function renderAccount(){
    return `
      <h2>1) Cuenta & contacto</h2>
      <div class="row">
        <div>
          <label>Email</label>
          <div class="inline"><input id="email" type="email" placeholder="tu@email.com" value="${esc(data.account.email)}"><button class="btn ghost" id="sendEmail">Enviar código</button></div>
          <div class="inline"><input id="emailCode" placeholder="Código"><button class="btn ghost" id="verifyEmail">Verificar</button></div>
          <div class="hint">${data.account.emailVerified? '✅ Email verificado':'Aún no verificado'}</div>
        </div>
        <div>
          <label>Teléfono</label>
          <div class="inline"><input id="phone" placeholder="+1 555 123 4567" value="${esc(data.account.phone)}"><button class="btn ghost" id="sendSms">SMS código</button></div>
          <div class="inline"><input id="smsCode" placeholder="Código"><button class="btn ghost" id="verifySms">Verificar</button></div>
          <div class="hint">${data.account.phoneVerified? '✅ SMS verificado':'Aún no verificado'}</div>
        </div>
      </div>
      <div class="row">
        <div>
          <label>Handle (minúsculas, guiones)</label>
          <input id="handle" placeholder="p.ej. ink-aria" value="${esc(data.account.handle)}">
          <div class="hint">URL pública: /@<span id="previewHandle">${esc(data.account.handle)}</span></div>
        </div>
        <div>
          <label>Idioma</label>
          <select id="locale">
            <option value="es" ${data.account.locale==='es'?'selected':''}>Español</option>
            <option value="en" ${data.account.locale==='en'?'selected':''}>English</option>
          </select>
        </div>
      </div>
    `;
  }

  function renderIdentity(){
    return `
      <h2>2) Identidad</h2>
      <div class="row">
        <div><label>Nombre</label><input id="firstName" value="${esc(data.identity.firstName)}"></div>
        <div><label>Apellido</label><input id="lastName" value="${esc(data.identity.lastName)}"></div>
      </div>
      <div class="row">
        <div><label>País</label><input id="idCountry" placeholder="p.ej. ES / MX / JP" value="${esc(data.identity.country)}"></div>
        <div><label>Fecha de nacimiento</label><input id="dob" type="date" value="${esc(data.identity.dob)}"></div>
      </div>
      <div class="row">
        <div>
          <label>Tipo de documento</label>
          <select id="docType">
            <option value="">Selecciona</option>
            <option value="passport" ${sel('passport',data.identity.idDoc.type)}>Pasaporte</option>
            <option value="id-card" ${sel('id-card',data.identity.idDoc.type)}>ID / DNI</option>
            <option value="driver-license" ${sel('driver-license',data.identity.idDoc.type)}>Licencia</option>
          </select>
        </div>
        <div><label>Documento (frente) — nombre de archivo</label><input id="docFront" placeholder="frente.jpg" value="${esc(data.identity.idDoc.front)}"></div>
      </div>
      <div class="row">
        <div><label>Documento (reverso) — nombre de archivo</label><input id="docBack" placeholder="reverso.jpg" value="${esc(data.identity.idDoc.back)}"></div>
        <div><label>Selfie — nombre de archivo</label><input id="selfie" placeholder="selfie.jpg" value="${esc(data.identity.selfie)}"></div>
      </div>
      <div class="hint">Fase 0: solo guardamos los nombres. En Fase 1 subiremos archivos reales a verificación.</div>
    `;
  }

  function renderProfile(){
    return `
      <h2>3) Perfil</h2>
      <div class="row">
        <div><label>Nombre público</label><input id="displayName" value="${esc(data.profile.displayName)}"></div>
        <div><label>Categorías (coma separadas)</label><input id="categories" placeholder="cosplay, fitness" value="${esc(data.profile.categories.join(', '))}"></div>
      </div>
      <label>Bio</label>
      <textarea id="bio" placeholder="Cuéntanos de tu contenido...">${esc(data.profile.bio)}</textarea>
      <label>Links (uno por línea)</label>
      <textarea id="links" placeholder="https://instagram.com/tuuser
https://tiktok.com/@tuuser
">${esc((data.profile.links||[]).join('\n'))}</textarea>
    `;
  }

  function renderPayouts(){
    return `
      <h2>4) Pagos</h2>
      <div class="row">
        <div>
          <label>Método</label>
          <select id="pMethod">
            <option value="">Selecciona</option>
            <option value="stripe" ${sel('stripe',data.payouts.method)}>Stripe</option>
            <option value="wise" ${sel('wise',data.payouts.method)}>Wise</option>
            <option value="bank" ${sel('bank',data.payouts.method)}>Transferencia bancaria</option>
          </select>
        </div>
        <div><label>País</label><input id="pCountry" placeholder="p.ej. ES" value="${esc(data.payouts.country)}"></div>
      </div>
      <div class="row">
        <div><label>Moneda</label><input id="pCurrency" placeholder="EUR / USD / JPY" value="${esc(data.payouts.currency)}"></div>
        <div>
          <label>Estado</label>
          <select id="pStatus">
            <option value="">—</option>
            <option value="pending" ${sel('pending',data.payouts.status)}>Pendiente</option>
            <option value="verified" ${sel('verified',data.payouts.status)}>Verificado</option>
          </select>
        </div>
      </div>
      <div class="hint">En Fase 1 lanzaremos el onboarding de pagos según el método seleccionado.</div>
    `;
  }

  function renderSecurity(){
    return `
      <h2>5) Seguridad</h2>
      <div class="inline">
        <label>Segundo factor (2FA):</label>
        <label class="inline"><input type="radio" name="twoFA" value="sms" ${data.security.twoFA==='sms'?'checked':''}> SMS</label>
        <label class="inline"><input type="radio" name="twoFA" value="app" ${data.security.twoFA==='app'?'checked':''}> App (TOTP)</label>
        <label class="inline"><input type="radio" name="twoFA" value="none" ${data.security.twoFA==='none'?'checked':''}> Ninguno (no recomendado)</label>
      </div>
      <div class="hint">Recomendamos SMS o App. El panel de revisión marca como advertencia si 2FA está desactivado.</div>
    `;
  }

  function renderAgreements(){
    return `
      <h2>6) Acuerdos</h2>
      <div class="review-line">
        <div>Términos & Condiciones</div>
        <label class="inline"><input id="tos" type="checkbox" ${data.agreements.tosAccepted?'checked':''}> Acepto</label>
      </div>
      <div class="review-line">
        <div>Política de contenido</div>
        <label class="inline"><input id="content" type="checkbox" ${data.agreements.contentAccepted?'checked':''}> Acepto</label>
      </div>
      <div class="review-line">
        <div>Revenue share</div>
        <div class="inline">
          <input id="rev" type="checkbox" ${data.agreements.revShareAccepted?'checked':''}> Acepto
          <span class="chip">Porcentaje: <b id="revPctLbl">${Number(data.agreements.revSharePct||20)}</b>%</span>
        </div>
      </div>
      <label style="margin-top:8px">Selecciona porcentaje</label>
      <input id="revPct" type="range" min="5" max="40" step="1" value="${Number(data.agreements.revSharePct||20)}">
      <div class="hint">Se puede ajustar por país/categoría en futuro. El valor aquí se incluye en la solicitud.</div>
    `;
  }

  function renderReview(){
    const list = [
      ['Email', data.account.email + (data.account.emailVerified?' (verificado)':'')],
      ['Teléfono', (data.account.phone||'—') + (data.account.phoneVerified?' (verificado)':'')],
      ['Handle', '@'+(data.account.handle||'')],
      ['Nombre', [data.identity.firstName,data.identity.lastName].filter(Boolean).join(' ')||'—'],
      ['País', data.identity.country||'—'],
      ['DOB', data.identity.dob||'—'],
      ['Doc', (data.identity.idDoc.type||'—') + (data.identity.idDoc.front? ' · frente':'') + (data.identity.idDoc.back? ' · reverso':'')],
      ['Selfie', data.identity.selfie? 'sí':'—'],
      ['Nombre público', data.profile.displayName||'—'],
      ['Categorías', (data.profile.categories||[]).join(', ')||'—'],
      ['Links', (data.profile.links||[]).join(', ')||'—'],
      ['Pagos', [data.payouts.method||'—', data.payouts.country||'', data.payouts.currency||'', data.payouts.status||''].filter(Boolean).join(' · ')],
      ['2FA', data.security.twoFA||'—'],
      ['Acuerdos', [
          data.agreements.tosAccepted?'TOS ✓':'TOS ×',
          data.agreements.contentAccepted?'Contenido ✓':'Contenido ×',
          (data.agreements.revShareAccepted?'RevShare ✓':'RevShare ×') + ` (${data.agreements.revSharePct||20}%)`
        ].join(' · ')
      ],
    ];
    return `
      <h2>7) Revisión</h2>
      ${list.map(([k,v])=>`<div class="review-line"><div>${k}</div><div style="opacity:.85">${esc(v)}</div></div>`).join('')}
      <div class="actions" style="margin-top:12px">
        <button class="btn ok" id="btn-send-api">Enviar a API</button>
        <button class="btn" id="btn-download">Descargar solicitud (JSON)</button>
      </div>
      <p class="hint">El archivo es compatible con el panel de <a href="./review.html">Revisión</a>. Con “Enviar a API” quedará en la bandeja remota.</p>
    `;
  }

  // ====== Validaciones ======
  function validateAccount(){
    syncAccount();
    if (!data.account.email) return {ok:false,msg:'Email es requerido.'};
    if (!/^[^@\s]+@[^@\s]+\.[^@\s]+$/.test(data.account.email)) return {ok:false,msg:'Email no válido.'};
    if (!data.account.handle) return {ok:false,msg:'Handle es requerido.'};
    if (!/^[a-z0-9]+(?:-[a-z0-9]+)*$/.test(data.account.handle)) return {ok:false,msg:'Handle en minúsculas y guiones.'};
    return {ok:true};
  }
  function validateIdentity(){
    syncIdentity();
    if (!data.identity.firstName || !data.identity.lastName) return {ok:false,msg:'Nombre y Apellido son requeridos.'};
    if (!data.identity.country) return {ok:false,msg:'País requerido.'};
    if (!data.identity.dob) return {ok:false,msg:'Fecha de nacimiento requerida.'};
    return {ok:true};
  }
  function validateProfile(){
    syncProfile();
    if (!data.profile.displayName) return {ok:false,msg:'Nombre público requerido.'};
    return {ok:true};
  }
  function validatePayouts(){
    syncPayouts();
    if (data.payouts.method && !data.payouts.currency) return {ok:false,msg:'Indica moneda para el método de pago.'};
    return {ok:true};
  }
  function validateAgreements(){
    syncAgreements();
    if (!data.agreements.tosAccepted || !data.agreements.contentAccepted) return {ok:false,msg:'Debes aceptar Términos y Política de contenido.'};
    return {ok:true};
  }

  // ====== Attach y sincronización ======
  function attachHandlers(){
    $('#btn-next').onclick = next;
    $('#btn-prev').onclick = prev;
    $('#btn-save').onclick = saveDraft;
    $('#btn-clear').onclick = ()=>{ data=getEmpty(); clearDraft(); idx=0; render(); toast('Formulario limpio','ok'); };

    if (idx===0){
      $('#email').oninput = e=>{ data.account.email = e.target.value.trim(); };
      $('#phone').oninput = e=>{ data.account.phone = e.target.value.trim(); };
      $('#handle').oninput = e=>{ data.account.handle = slug(e.target.value); $('#previewHandle').textContent=data.account.handle; };
      $('#locale').onchange = e=>{ data.account.locale = e.target.value; };
      $('#sendEmail').onclick = ()=>toast('Código enviado al email (demo)', 'ok');
      $('#sendSms').onclick   = ()=>toast('Código SMS enviado (demo)', 'ok');
      $('#verifyEmail').onclick = ()=>{ data.account.emailVerified = true; render(); };
      $('#verifySms').onclick = ()=>{ data.account.phoneVerified = true; render(); };
    }
    if (idx===1){
      $('#firstName').oninput = e=>data.identity.firstName=e.target.value;
      $('#lastName').oninput  = e=>data.identity.lastName =e.target.value;
      $('#idCountry').oninput = e=>data.identity.country  =e.target.value.toUpperCase();
      $('#dob').onchange      = e=>data.identity.dob      =e.target.value;
      $('#docType').onchange  = e=>data.identity.idDoc.type=e.target.value;
      $('#docFront').oninput  = e=>data.identity.idDoc.front=e.target.value;
      $('#docBack').oninput   = e=>data.identity.idDoc.back =e.target.value;
      $('#selfie').oninput    = e=>data.identity.selfie     =e.target.value;
    }
    if (idx===2){
      $('#displayName').oninput = e=>data.profile.displayName=e.target.value;
      $('#bio').oninput         = e=>data.profile.bio       =e.target.value;
      $('#categories').oninput  = e=>data.profile.categories = e.target.value.split(',').map(s=>s.trim()).filter(Boolean);
      $('#links').oninput       = e=>data.profile.links = e.target.value.split('\n').map(s=>s.trim()).filter(Boolean);
    }
    if (idx===3){
      $('#pMethod').onchange  = e=>data.payouts.method  =e.target.value;
      $('#pCountry').oninput  = e=>data.payouts.country =e.target.value.toUpperCase();
      $('#pCurrency').oninput = e=>data.payouts.currency=e.target.value.toUpperCase();
      $('#pStatus').onchange  = e=>data.payouts.status  =e.target.value;
    }
    if (idx===4){
      $$('input[name="twoFA"]').forEach(r=>r.onchange = e=>{ if(e.target.checked) data.security.twoFA=e.target.value; });
    }
    if (idx===5){
      $('#tos').onchange     = e=>data.agreements.tosAccepted = e.target.checked;
      $('#content').onchange = e=>data.agreements.contentAccepted = e.target.checked;
      $('#rev').onchange     = e=>data.agreements.revShareAccepted = e.target.checked;
      $('#revPct').oninput   = e=>{ data.agreements.revSharePct = Number(e.target.value); $('#revPctLbl').textContent=e.target.value; };
    }
    if (idx===6){
      $('#btn-download').onclick = downloadJSON;
      $('#btn-send-api').onclick = sendToAPI;
    }
  }

  function syncAccount(){ data.account.handle = slug(data.account.handle||''); }
  function syncIdentity(){}
  function syncProfile(){}
  function syncPayouts(){}
  function syncAgreements(){}

  // ====== Util ======
  function slug(s){ return String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,''); }
  function esc(s){ return (s==null?'':String(s)).replace(/[&<>"]/g, c=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;' }[c])); }
  function sel(v,cur){ return v===cur?'selected':''; }

  function buildPayload(){
    const out = JSON.parse(JSON.stringify(data));
    out.meta = out.meta || {};
    out.meta.createdAt = new Date().toISOString();
    out.meta.source = 'onboarding-local';
    return out;
  }

  function downloadJSON(){
    const out = buildPayload();
    const fn = `solicitud_${(out.account.handle||'creator')}_${new Date().toISOString().slice(0,19)}.json`;
    const blob = new Blob([JSON.stringify(out,null,2)], {type:'application/json'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a'); a.href=url; a.download=fn; document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
    try{ window.plausible && plausible('onboarding_download'); }catch{}
  }

  async function sendToAPI(){
    const out = buildPayload();
    try{
      const res = await fetch(`${API_BASE}/api/submissions`, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify(out)
      });
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const json = await res.json();
      toast(`Enviado a API ✓ ID: ${json.id}`, 'ok');
      try{ window.plausible && plausible('onboarding_send_api'); }catch{}
    }catch(err){
      toast('No se pudo enviar a la API', 'err');
      console.error(err);
    }
  }

  // init
  render();
})();
</script>
  <script src="./_header.js" defer></script>
</body>
</html>
